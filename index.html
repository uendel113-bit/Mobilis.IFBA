<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobilis - IFBA Juazeiro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (Dashboard Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF & jsPDF-AutoTable (PDF Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,routes" async defer></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch,
        };
    </script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* IFBA Color Palette */
        :root {
            --ifba-green-dark: #1C5240;
            --ifba-green-light: #2F8C56;
            --ifba-accent-gold: #F2A30F;
            --ifba-red-error: #D32F2F;
        }

        .bg-ifba-green-dark { background-color: var(--ifba-green-dark); }
        .text-ifba-green-dark { color: var(--ifba-green-dark); }
        .bg-ifba-green-light { background-color: var(--ifba-green-light); }
        .text-ifba-green-light { color: var(--ifba-green-light); }
        .bg-ifba-accent-gold { background-color: var(--ifba-accent-gold); }
        .text-ifba-accent-gold { color: var(--ifba-accent-gold); }
        .border-ifba-green-dark { border-color: var(--ifba-green-dark); }
        .border-ifba-green-light { border-color: var(--ifba-green-light); }
        
        /* 3D Button Style */
        .btn-3d {
            transition: all 0.15s ease-out;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 0 var(--shadow-color);
        }
        .btn-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 0 var(--shadow-color);
        }
        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 var(--shadow-color);
        }
        .btn-green {
             --shadow-color: #1a493a; /* Darker green */
             background-color: var(--ifba-green-dark);
        }
        .btn-gold {
            --shadow-color: #c8870c; /* Darker gold */
            background-color: var(--ifba-accent-gold);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--ifba-green-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--ifba-green-dark);
        }
        .hidden {
            display: none;
        }

        /* Centered Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">

        <!-- Header Logos -->
        <header class="flex justify-between items-center mb-6">
            <img id="supervisorLogoLeft" src="https://placehold.co/150x50/FFFFFF/1C5240?text=Logo+Esquerda" alt="Logo Esquerda" class="h-12 hidden">
            <img id="supervisorLogoRight" src="https://placehold.co/150x50/FFFFFF/1C5240?text=Logo+Direita" alt="Logo Direita" class="h-12 hidden">
        </header>

        <!-- Dynamic Content Area -->
        <main id="content-area">
            <!-- Initial Screen -->
            <div id="initial-screen">
                <div class="text-center mb-8">
                    <img src="https://i.ibb.co/6yVw2WN/mob.png" alt="Mobilis Logo" class="mx-auto w-48 mb-4">
                    <h1 class="text-4xl font-bold text-ifba-green-dark">Mobilis</h1>
                    <p class="text-lg text-gray-600">Monitoramento de Transporte do IFBA Juazeiro</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="showScreen('user-login-screen')" class="p-8 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
                        <i data-lucide="user-round" class="w-16 h-16 mx-auto mb-4 text-ifba-green-dark"></i>
                        <h2 class="text-2xl font-semibold">Sou Estudante</h2>
                        <p class="text-gray-500">Registrar e avaliar minhas viagens.</p>
                    </button>
                    <button onclick="showScreen('supervisor-login-screen')" class="p-8 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
                        <i data-lucide="user-cog" class="w-16 h-16 mx-auto mb-4 text-ifba-green-dark"></i>
                        <h2 class="text-2xl font-semibold">Sou Supervisor</h2>
                        <p class="text-gray-500">Acessar painel e relatórios.</p>
                    </button>
                </div>
            </div>

            <!-- User Login/Register Screen -->
            <div id="user-login-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Acesso do Estudante</h2>
                <div id="user-auth-form">
                    <input type="text" id="userName" placeholder="Nome Completo" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <select id="userCourse" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none bg-white">
                        <option value="" disabled selected>Selecione seu Curso</option>
                        <option>Ensino Médio</option>
                        <option>Curso técnico em Administração</option>
                        <option>Curso técnico em Segurança do Trabalho</option>
                        <option>Cursos superiores de Tecnologia em Logística</option>
                    </select>
                    <p id="user-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="loginUser()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Entrar / Cadastrar</button>
                </div>
            </div>

            <!-- Supervisor Login Screen -->
            <div id="supervisor-login-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Acesso do Supervisor</h2>
                <div id="supervisor-auth-form">
                    <input type="text" id="supervisorLogin" placeholder="Login" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <input type="password" id="supervisorPassword" placeholder="Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <p id="supervisor-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="loginSupervisor()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Entrar</button>
                </div>
            </div>
            
            <!-- Main User Interface (after login) -->
            <div id="main-user-interface" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Olá, <span id="display-user-name"></span>!</h2>
                    <button onclick="logout()" class="text-sm text-red-600 hover:underline">Sair</button>
                </div>
                <!-- Journey Steps -->
                <div id="journey-start">
                    <h3 class="text-lg font-semibold mb-2">Iniciar Nova Viagem</h3>
                    <p class="mb-4 text-gray-600">Selecione a linha de ônibus para começar.</p>
                    <select id="bus-line-select" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none bg-white">
                        <option value="" disabled selected>Selecione uma linha...</option>
                        <!-- Options will be populated by JS -->
                    </select>
                    <input type="text" id="bus-line-manual" placeholder="Ou digite o nome/código da linha" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <p id="bus-line-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="startWaiting()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-green flex items-center justify-center gap-2">
                        <i data-lucide="timer"></i>
                        Estou em espera do ônibus
                    </button>
                </div>

                <div id="journey-waiting" class="hidden text-center">
                    <h3 class="text-lg font-semibold mb-2">Aguardando ônibus...</h3>
                    <p class="text-gray-600">Linha: <span id="waiting-bus-line" class="font-bold"></span></p>
                    <div class="my-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-ifba-green-dark mx-auto"></div>
                        <p class="text-4xl font-bold mt-4" id="waiting-timer">00:00</p>
                    </div>
                     <div id="eta-info" class="bg-blue-100 border border-blue-300 text-blue-800 p-3 rounded-md my-4 hidden">
                        <p id="eta-message"></p>
                     </div>
                    <button onclick="startTrip()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-gold flex items-center justify-center gap-2">
                        <i data-lucide="bus-front"></i>
                        Embarquei! Iniciar Viagem
                    </button>
                </div>

                <div id="journey-in-progress" class="hidden">
                     <h3 class="text-lg font-semibold mb-2 text-center">Viagem em andamento...</h3>
                     <p class="text-gray-600 text-center mb-4">Linha: <span id="trip-bus-line" class="font-bold"></span></p>
                    
                     <!-- Map Area -->
                     <div id="map-container" class="w-full h-64 bg-gray-200 rounded-lg mb-4 border-2 border-ifba-green-dark">
                         <div id="map" style="height: 100%; width: 100%;"></div>
                     </div>
                     <p class="text-center font-semibold text-lg mb-4">Tempo de viagem: <span id="trip-timer">00:00</span></p>

                    <button onclick="endTrip()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-green flex items-center justify-center gap-2">
                        <i data-lucide="flag-off"></i>
                        Desembarque realizado
                    </button>
                </div>

                <!-- User Trip History -->
                <div id="user-history" class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 border-b-2 pb-2 border-ifba-green-light">Histórico de Viagens (Últimas 30)</h3>
                    <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <!-- History items will be populated by JS -->
                        <p id="no-history-message" class="text-gray-500">Nenhuma viagem registrada ainda.</p>
                    </div>
                </div>
            </div>

            <!-- Connection Popup -->
            <div id="connection-popup" class="popup-overlay hidden">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
                    <h3 class="text-xl font-bold text-ifba-green-dark mb-4">Haverá conexão?</h3>
                    <p class="text-gray-600 mb-6">Você vai pegar outro ônibus para completar sua viagem?</p>
                    <div class="flex justify-around">
                        <button onclick="handleConnection(true)" class="px-8 py-3 rounded-md text-white font-semibold btn-3d btn-green">Sim</button>
                        <button onclick="handleConnection(false)" class="px-8 py-3 rounded-md text-white font-semibold btn-3d btn-gold">Não</button>
                    </div>
                </div>
            </div>

            <!-- Rating Screen -->
            <div id="rating-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Avalie sua Viagem</h2>
                
                <!-- Bus Stop Rating -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">Ponto de Ônibus</h3>
                    <div class="space-y-4">
                        <div id="stop-rating-criteria"></div>
                        <textarea id="stop-rating-comments" placeholder="Comentários adicionais sobre o ponto (opcional)" class="w-full p-2 border rounded-md" rows="2"></textarea>
                    </div>
                </div>

                <!-- Bus Rating -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">Ônibus</h3>
                    <div class="space-y-4">
                         <div id="bus-rating-criteria"></div>
                         <textarea id="bus-rating-comments" placeholder="Comentários adicionais sobre o ônibus (opcional)" class="w-full p-2 border rounded-md" rows="2"></textarea>
                    </div>
                </div>
                <p id="rating-error" class="text-red-500 text-sm mt-4 hidden"></p>
                <button onclick="submitRating()" class="w-full mt-6 p-3 rounded-md text-white font-semibold btn-3d btn-green">Enviar Avaliação</button>
            </div>

             <!-- Summary Screen -->
            <div id="summary-screen" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Resumo da Viagem</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Tempo de Espera</p>
                        <p id="summary-wait-time" class="text-2xl font-bold">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Tempo de Viagem</p>
                        <p id="summary-trip-time" class="text-2xl font-bold">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg col-span-2 md:col-span-1">
                        <p class="text-sm text-gray-500">Tempo Total</p>
                        <p id="summary-total-time" class="text-2xl font-bold text-ifba-green-dark">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Distância</p>
                        <p id="summary-distance" class="text-2xl font-bold">-- km</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Custo Aprox.</p>
                        <p id="summary-cost" class="text-2xl font-bold">R$ --,--</p>
                    </div>
                </div>
                <p class="mt-6 text-gray-500 text-sm">Esta tela fechará em <span id="summary-countdown">30</span>s.</p>
            </div>

            <!-- Supervisor Dashboard -->
            <div id="supervisor-dashboard" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-ifba-green-dark">Dashboard do Supervisor</h2>
                     <div>
                        <button onclick="showScreen('supervisor-password-change')" class="text-sm text-blue-600 hover:underline mr-4">Trocar Senha</button>
                        <button onclick="logout()" class="text-sm text-red-600 hover:underline">Sair</button>
                     </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-2">Ações</h3>
                    <div class="flex flex-wrap gap-2">
                        <select id="report-period" class="p-2 border rounded-md bg-white">
                            <option value="daily">Diário</option>
                            <option value="weekly">Semanal</option>
                            <option value="biweekly">Quinzenal</option>
                            <option value="monthly">Mensal</option>
                            <option value="semiannual">Semestral</option>
                            <option value="annual">Anual</option>
                        </select>
                        <button onclick="generatePDFReport()" class="p-2 rounded-md text-white btn-3d btn-green flex items-center gap-1"><i data-lucide="file-down"></i>Gerar PDF</button>
                        <button onclick="showScreen('manage-lines-screen')" class="p-2 rounded-md text-white btn-3d btn-gold flex items-center gap-1"><i data-lucide="bus"></i>Gerenciar Linhas</button>
                        <button onclick="showScreen('manage-logos-screen')" class="p-2 rounded-md text-white btn-3d btn-gold flex items-center gap-1"><i data-lucide="image"></i>Gerenciar Logos</button>
                         <button id="clear-history-btn" onclick="confirmClearHistories()" class="p-2 rounded-md text-white bg-red-600 hover:bg-red-700 flex items-center gap-1" style="box-shadow: 0 4px 0 0 #ab2424;"><i data-lucide="trash-2"></i>Limpar Históricos</button>
                         <button onclick="generateAISummary()" class="p-2 rounded-md text-white btn-3d btn-green flex items-center gap-1" style="background-color: #4a148c; --shadow-color: #380f6b;">✨ Gerar Resumo com IA</button>
                    </div>
                </div>

                <!-- AI Summary Box -->
                <div id="ai-summary-box" class="hidden bg-purple-50 border-l-4 border-purple-500 text-purple-800 p-4 rounded-md mb-6 shadow">
                    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="sparkles"></i>Resumo da Inteligência Artificial</h3>
                    <div id="ai-summary-content" class="text-sm space-y-2">
                        <p class="animate-pulse">Analisando dados e gerando insights...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Main Chart: Average Delays -->
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Atrasos Médios por Linha (minutos)</h3>
                        <canvas id="delay-chart"></canvas>
                    </div>
                    
                    <!-- Other Metrics -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Causas Prováveis dos Atrasos</h3>
                        <canvas id="causes-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Lotação Média por Horário</h3>
                        <canvas id="occupancy-chart"></canvas>
                    </div>
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                         <h3 class="font-semibold mb-2">Avaliação Média dos Itens dos Pontos de Ônibus</h3>
                         <canvas id="stop-items-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Avaliação Média dos Ônibus</h3>
                        <canvas id="bus-rating-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Custo Médio Total por Viagem</h3>
                        <canvas id="cost-chart"></canvas>
                    </div>
                </div>

                 <!-- User Mode Button -->
                <div class="mt-8 text-center">
                    <button onclick="switchToUserView()" class="p-3 rounded-md text-white font-semibold btn-3d btn-gold">
                        <i data-lucide="user-round" class="inline-block mr-2"></i>Visualizar como Estudante
                    </button>
                </div>

            </div>

             <!-- Supervisor: Manage Lines Screen -->
            <div id="manage-lines-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Gerenciar Linhas de Ônibus</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Adicionar Nova Linha</h3>
                    <input type="text" id="newLinePrefix" placeholder="Prefixo (Ex: 102)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="text" id="newLineRoute" placeholder="Rota (Ex: João Paulo II - Brisa da Serra)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="text" id="newLineTimes" placeholder="Horários (separados por vírgula)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="number" id="newLineCost" placeholder="Custo Aprox. (Ex: 2.50)" class="w-full p-2 mb-2 border rounded-md">
                    <button onclick="addNewLine()" class="w-full p-2 rounded-md text-white btn-3d btn-green">Adicionar Linha</button>
                </div>
                 <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Importar Linhas (CSV/TXT)</h3>
                    <input type="file" id="importFile" accept=".csv,.txt" class="w-full p-2 border rounded-md">
                    <button onclick="importLines()" class="w-full mt-2 p-2 rounded-md text-white btn-3d btn-gold">Importar Arquivo</button>
                 </div>

                <h3 class="text-lg font-semibold mb-2">Linhas Cadastradas</h3>
                <div id="lines-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Lines list populated by JS -->
                </div>
                
                <button onclick="showScreen('supervisor-dashboard')" class="mt-6 p-3 rounded-md text-ifba-green-dark font-semibold border-2 border-ifba-green-dark hover:bg-gray-100 w-full">Voltar ao Dashboard</button>
            </div>

            <!-- Supervisor: Change Password Screen -->
            <div id="supervisor-password-change" class="hidden bg-white p-8 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Alterar Senha</h2>
                 <input type="password" id="currentSupervisorPassword" placeholder="Senha Atual" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <input type="password" id="newSupervisorPassword" placeholder="Nova Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <input type="password" id="confirmNewSupervisorPassword" placeholder="Confirmar Nova Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <p id="password-change-error" class="text-red-500 text-sm mb-4 hidden"></p>
                 <p id="password-change-success" class="text-green-600 text-sm mb-4 hidden"></p>
                 <button onclick="changeSupervisorPassword()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Salvar Nova Senha</button>
                 <button onclick="showScreen('supervisor-dashboard')" class="mt-4 w-full text-center text-gray-600 hover:underline">Voltar</button>
            </div>

            <!-- Supervisor: Manage Logos Screen -->
            <div id="manage-logos-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Gerenciar Logos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Logo Esquerdo</h3>
                        <input type="file" id="logoLeftFile" accept="image/*" class="w-full p-2 border rounded-md mb-2">
                        <img id="logoLeftPreview" src="https://placehold.co/200x70?text=Preview" alt="Preview Logo Esquerdo" class="w-full border p-2 rounded-md">
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold mb-2">Logo Direito</h3>
                        <input type="file" id="logoRightFile" accept="image/*" class="w-full p-2 border rounded-md mb-2">
                        <img id="logoRightPreview" src="https://placehold.co/200x70?text=Preview" alt="Preview Logo Direito" class="w-full border p-2 rounded-md">
                    </div>
                </div>
                <button onclick="saveLogos()" class="w-full mt-6 p-3 rounded-md text-white font-semibold btn-3d btn-green">Salvar Logos</button>
                <button onclick="showScreen('supervisor-dashboard')" class="mt-4 w-full text-center text-gray-600 hover:underline">Voltar</button>
            </div>
            
        </main>
    </div>

    <script>
    // --- Application State and Configuration ---
    let appState = {
        currentScreen: 'initial-screen',
        currentUser: null,
        currentTrip: null,
        tripInterval: null,
        waitingInterval: null,
        summaryTimeout: null,
        map: null,
        userMarker: null,
        busMarker: null,
        routePolyline: null,
        db: null,
        auth: null,
        userId: null,
    };
    
    // IFBA Campus Coordinates
    const IFBA_CAMPUS_COORDS = { lat: -9.450303676457963, lng: -40.52378313230595 };

    // --- Firebase Initialization ---
    // IMPORTANT: Replace with your actual Firebase config
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    function initializeFirebase() {
        // In a real environment, __firebase_config would be provided.
        const effectiveConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        
        try {
            const app = window.firebase.initializeApp(effectiveConfig);
            appState.db = window.firebase.getFirestore(app);
            appState.auth = window.firebase.getAuth(app);
            console.log("Firebase initialized.");
            setupAuthListener();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Show an error to the user that the app cannot connect to its services.
        }
    }

    async function setupAuthListener() {
        window.firebase.onAuthStateChanged(appState.auth, async (user) => {
            if (user) {
                appState.userId = user.uid;
                console.log("User is signed in with UID:", appState.userId);
                // If the user has a profile, load it.
                const userDoc = await window.firebase.getDoc(window.firebase.doc(appState.db, "users", appState.userId));
                if (userDoc.exists()) {
                    appState.currentUser = userDoc.data();
                    if (appState.currentUser.profile === 'student') {
                        setupUserInterface(appState.currentUser.name);
                        loadUserHistory();
                    }
                }
            } else {
                console.log("User is signed out.");
                appState.currentUser = null;
                appState.userId = null;
                showScreen('initial-screen');
            }
        });

        // Sign in automatically (for this demo app context)
        try {
             if (typeof __initial_auth_token !== 'undefined') {
                await window.firebase.signInWithCustomToken(appState.auth, __initial_auth_token);
             } else {
                await window.firebase.signInAnonymously(appState.auth);
             }
        } catch (error) {
            console.error("Anonymous sign-in failed:", error);
        }
    }

    // --- UI Navigation ---
    function showScreen(screenId) {
        document.querySelectorAll('#content-area > div').forEach(screen => {
            screen.classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
        appState.currentScreen = screenId;
    }

    // --- Initial Data ---
    let busLines = [
        { id: 1, prefix: '102', route: 'João Paulo II - Residencial Brisa da Serra', cost: 2.50 },
        { id: 2, prefix: '106', route: 'Piranga', cost: 2.50 },
        { id: 3, prefix: '200', route: 'Dom José Rodrigues', cost: 2.50 },
        { id: 4, prefix: '202', route: 'Residencial Doutor Humberto Martins', cost: 2.50 },
        { id: 5, prefix: '203', route: 'Kidé', cost: 2.50 },
        { id: 6, prefix: '204', route: 'Circular Itaberaba', cost: 2.50 },
        { id: 7, prefix: '205', route: 'Tancredo Neves - Castelo Branco', cost: 2.50 },
        { id: 8, prefix: '206', route: 'Residencial Praia do Rodeadouro', cost: 2.50 },
        { id: 9, prefix: '207', route: 'Residencial São Francisco', cost: 2.50 },
        { id: 10, prefix: '208', route: 'Jardim Primavera', cost: 2.50 },
        { id: 11, prefix: '209', route: 'Carnaíba do Sertão', cost: 2.50 },
        { id: 12, prefix: '210', route: 'Rodeadouro', cost: 2.50 },
        { id: 13, prefix: '211', route: 'Curral Novo - Sabiá', cost: 2.50 },
        { id: 14, prefix: '401', route: 'Juazeiro - Petrolina via Centro', cost: 2.50 },
        { id: 15, prefix: '402', route: 'Juazeiro - Petrolina / Areia Branca', cost: 2.50 },
        { id: 16, prefix: '405', route: 'Juazeiro - Sobradinho', cost: 2.50 },
        { id: 17, prefix: '414', route: 'Juazeiro - Petrolina - IF Sertão', cost: 2.50 },
        { id: 18, prefix: '416', route: 'Juazeiro - Petrolina - Expresso', cost: 2.50 },
        { id: 19, prefix: '420', route: 'Juá Garden - Petrolina - Areia Branca', cost: 2.50 },
    ];
    
    const ratingCriteria = {
        bus: [
            { id: 'cleanliness', label: 'Limpeza do veículo' },
            { id: 'driver_treatment', label: 'Tratamento do motorista/cobrador' },
            { id: 'traffic_speed', label: 'Velocidade de tráfego' },
            { id: 'crowding', label: 'Lotação do ônibus' }
        ],
        stop: [
            { id: 'access_ramp', label: 'Rampa de acesso' },
            { id: 'coverage', label: 'Cobertura do ponto' },
            { id: 'lighting', label: 'Iluminação do ponto' },
            { id: 'accessible_floor', label: 'Piso com acessibilidade' },
            { id: 'signaling', label: 'Sinalização' },
            { id: 'security', label: 'Segurança' }
        ]
    };

    const ratingOptions = [
        { value: 1, label: 'Ruim', emoji: '😠' },
        { value: 2, label: 'Insatisfeito', emoji: '😞' },
        { value: 3, label: 'Razoável', emoji: '😐' },
        { value: 4, label: 'Neutro', emoji: '🙂' },
        { value: 5, label: 'Satisfeito', emoji: '😊' },
        { value: 6, label: 'Plenamente Satisfeito', emoji: '😍' }
    ];

    function populateBusLines() {
        const select = document.getElementById('bus-line-select');
        select.innerHTML = '<option value="" disabled selected>Selecione uma linha...</option>';
        busLines.forEach(line => {
            const option = document.createElement('option');
            option.value = line.id;
            option.textContent = `${line.prefix} - ${line.route}`;
            select.appendChild(option);
        });
    }
    
    function createRatingControls(containerId, criteria) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        criteria.forEach(item => {
            const fieldset = document.createElement('fieldset');
            fieldset.className = 'border p-3 rounded-md';
            fieldset.innerHTML = `<legend class="px-2 font-medium text-gray-700">${item.label}</legend>
                <div class="flex justify-around flex-wrap gap-2" data-criteria="${item.id}">
                    ${ratingOptions.map(opt => `
                        <label class="flex flex-col items-center cursor-pointer text-center">
                            <input type="radio" name="${item.id}" value="${opt.value}" class="hidden peer">
                            <span class="text-3xl p-1 rounded-full peer-checked:bg-yellow-200 transition-colors">${opt.emoji}</span>
                            <span class="text-xs mt-1 text-gray-600">${opt.label}</span>
                        </label>
                    `).join('')}
                </div>`;
            container.appendChild(fieldset);
        });
    }

    // --- Authentication ---
    async function loginUser() {
        const name = document.getElementById('userName').value.trim();
        const course = document.getElementById('userCourse').value;
        const errorEl = document.getElementById('user-error');
        
        if (!name || !course) {
            errorEl.textContent = 'Por favor, preencha todos os campos.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        appState.currentUser = { name, course, profile: 'student' };
        
        // Save user profile to Firestore
        try {
            await window.firebase.setDoc(window.firebase.doc(appState.db, "users", appState.userId), appState.currentUser);
            console.log("User profile saved.");
            setupUserInterface(name);
        } catch (error) {
            console.error("Error saving user profile: ", error);
            errorEl.textContent = 'Erro ao salvar perfil. Tente novamente.';
            errorEl.classList.remove('hidden');
        }
    }

    function setupUserInterface(name) {
        document.getElementById('display-user-name').textContent = name;
        showScreen('main-user-interface');
        loadUserHistory();
    }
    
    function loginSupervisor() {
        const login = document.getElementById('supervisorLogin').value;
        const password = document.getElementById('supervisorPassword').value;
        const errorEl = document.getElementById('supervisor-error');
        
        // This should be replaced with a secure server-side check
        console.log("Attempting login with:", { login, password });
        console.log("Expected credentials:", { login: "Logistica2025.1", password: "@#Log!20252" });

        if (login === 'Logistica2025.1' && password === '@#Log!20252') {
            errorEl.classList.add('hidden');
            appState.currentUser = { name: 'Supervisor', profile: 'supervisor' };
            showScreen('supervisor-dashboard');
            initializeDashboard();
            loadLogos();
        } else {
            errorEl.textContent = 'Login ou senha inválidos.';
            errorEl.classList.remove('hidden');
        }
    }

    function logout() {
        appState.currentUser = null;
        // In a real app with proper auth, you'd call signOut here.
        // window.firebase.signOut(appState.auth);
        clearInterval(appState.tripInterval);
        clearInterval(appState.waitingInterval);
        clearTimeout(appState.summaryTimeout);
        showScreen('initial-screen');
         // Hide supervisor logos when logging out
        document.getElementById('supervisorLogoLeft').classList.add('hidden');
        document.getElementById('supervisorLogoRight').classList.add('hidden');
    }

    // --- User Journey ---
    function getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocalização não é suportada pelo seu navegador.'));
            } else {
                navigator.geolocation.getCurrentPosition(
                    position => resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    }),
                    () => reject(new Error('Não foi possível obter sua localização.'))
                );
            }
        });
    }

    async function startWaiting() {
        const selectedLineId = document.getElementById('bus-line-select').value;
        const manualLine = document.getElementById('bus-line-manual').value.trim();
        const errorEl = document.getElementById('bus-line-error');

        let line;
        if (selectedLineId) {
            line = busLines.find(l => l.id == selectedLineId);
        } else if (manualLine) {
            // Simple logic for manual entry, could be improved
            line = { id: `manual_${Date.now()}`, prefix: manualLine, route: 'Rota manual', cost: 2.50 };
        }

        if (!line) {
            errorEl.textContent = 'Por favor, selecione ou digite uma linha.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        try {
            const location = await getCurrentLocation();
            
            appState.currentTrip = {
                id: `trip_${Date.now()}`,
                userId: appState.userId,
                lineId: line.id,
                lineName: `${line.prefix} - ${line.route}`,
                lineCost: line.cost,
                events: [],
                status: 'waiting',
            };
            
            appState.currentTrip.events.push({
                type: 'start_wait',
                timestamp: new Date().toISOString(),
                location: { lat: location.lat, lng: location.lng }
            });

            document.getElementById('waiting-bus-line').textContent = appState.currentTrip.lineName;
            showScreen('journey-waiting');

            let seconds = 0;
            const timerEl = document.getElementById('waiting-timer');
            appState.waitingInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.textContent = `${mins}:${secs}`;
            }, 1000);

            await checkETA(line.id);

        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.classList.remove('hidden');
        }
    }

    async function checkETA(lineId) {
        const etaInfo = document.getElementById('eta-info');
        const etaMessage = document.getElementById('eta-message');
        etaInfo.classList.add('hidden');

        try {
            // Check Firestore for a recent "start_trip" event on the same line
            const q = window.firebase.query(
                window.firebase.collection(appState.db, "realtime_bus"),
                window.firebase.where("lineId", "==", lineId)
            );
            const querySnapshot = await window.firebase.getDocs(q);

            if (!querySnapshot.empty) {
                const busDoc = querySnapshot.docs[0].data();
                const lastSeenTime = new Date(busDoc.timestamp);
                const now = new Date();
                const diffMinutes = Math.round((now - lastSeenTime) / (1000 * 60));
                
                // Use Google Maps to calculate ETA from last known bus position to user
                const userLocation = await getCurrentLocation();
                
                const directionsService = new google.maps.DirectionsService();
                const request = {
                    origin: new google.maps.LatLng(busDoc.location.lat, busDoc.location.lng),
                    destination: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    travelMode: 'DRIVING'
                };

                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        const eta = result.routes[0].legs[0].duration.text;
                         etaMessage.textContent = `Previsão de chegada: ${eta}. (Ônibus passou por um ponto há ${diffMinutes} min).`;
                         etaInfo.classList.remove('hidden');
                    } else {
                        etaMessage.textContent = `Um ônibus desta linha passou por um ponto próximo há ${diffMinutes} minuto(s).`;
                        etaInfo.classList.remove('hidden');
                    }
                });
            } else {
                 etaMessage.textContent = 'Aguardando informações de outros usuários para estimar a chegada.';
                 etaInfo.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error checking ETA:", error);
            etaInfo.classList.add('hidden');
        }
    }


    async function startTrip() {
        clearInterval(appState.waitingInterval);
        
        try {
            const location = await getCurrentLocation();
            appState.currentTrip.events.push({
                type: 'start_trip',
                timestamp: new Date().toISOString(),
                location: { lat: location.lat, lng: location.lng }
            });
            appState.currentTrip.status = 'in_progress';
            
            // Update realtime_bus location in Firestore
            await window.firebase.setDoc(window.firebase.doc(appState.db, "realtime_bus", appState.currentTrip.lineId.toString()), {
                lineId: appState.currentTrip.lineId,
                location: { lat: location.lat, lng: location.lng },
                timestamp: new Date().toISOString()
            });

            document.getElementById('trip-bus-line').textContent = appState.currentTrip.lineName;
            showScreen('journey-in-progress');

            initializeMap(location);

            let seconds = 0;
            const timerEl = document.getElementById('trip-timer');
            appState.tripInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.textContent = `${mins}:${secs}`;
            }, 1000);

        } catch(error) {
            alert('Erro ao iniciar a viagem: ' + error.message);
            // Revert to waiting screen or start screen
            showScreen('journey-start');
        }
    }
    
    function initializeMap(startLocation) {
        if (appState.map) {
             appState.map.remove();
        }

        const mapElement = document.getElementById('map');
        appState.map = L.map(mapElement).setView([startLocation.lat, startLocation.lng], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(appState.map);

        // User and IFBA markers
        const userIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448653.png', iconSize: [38, 38] });
        appState.busMarker = L.marker([startLocation.lat, startLocation.lng], { icon: userIcon }).addTo(appState.map).bindPopup("Você está aqui!");

        const ifbaIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/9906/9906517.png', iconSize: [38, 38] });
        L.marker([IFBA_CAMPUS_COORDS.lat, IFBA_CAMPUS_COORDS.lng], { icon: ifbaIcon }).addTo(appState.map).bindPopup("IFBA Campus Juazeiro");

        // Use Google Maps Directions API to get route
        const directionsService = new google.maps.DirectionsService();
        const request = {
            origin: new google.maps.LatLng(startLocation.lat, startLocation.lng),
            destination: new google.maps.LatLng(IFBA_CAMPUS_COORDS.lat, IFBA_CAMPUS_COORDS.lng),
            travelMode: 'DRIVING'
        };

        directionsService.route(request, (result, status) => {
            if (status == 'OK') {
                const route = result.routes[0];
                const eta = route.legs[0].duration.text;
                // Add ETA info to UI if needed

                // Decode polyline and draw on Leaflet map
                const latlngs = google.maps.geometry.encoding.decodePath(route.overview_polyline).map(p => [p.lat(), p.lng()]);
                
                if (appState.routePolyline) {
                    appState.map.removeLayer(appState.routePolyline);
                }
                appState.routePolyline = L.polyline(latlngs, { color: 'blue' }).addTo(appState.map);
                appState.map.fitBounds(appState.routePolyline.getBounds());
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
        
         // Dynamically update route - This is a simulation. A real app would get live bus data.
        let routeUpdateInterval = setInterval(() => {
            navigator.geolocation.getCurrentPosition(position => {
                 const newLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                 if (appState.busMarker) {
                     appState.busMarker.setLatLng(newLocation);
                     appState.map.panTo(newLocation);
                 }
                 // Recalculate route/ETA
            });
        }, 10000); // Update every 10 seconds
    }


    function endTrip() {
        clearInterval(appState.tripInterval);
        appState.currentTrip.events.push({
            type: 'end_trip',
            timestamp: new Date().toISOString(),
            location: null // Location is optional on arrival
        });
        appState.currentTrip.status = 'ended';
        showScreen('connection-popup');
    }

    function handleConnection(willConnect) {
        if (willConnect) {
            // Save current leg of the trip and start a new one
            saveTripToHistory();
            resetJourney(true); // isConnection = true
        } else {
            // End of journey, proceed to rating
            showScreen('rating-screen');
        }
    }
    
    function resetJourney(isConnection = false) {
        appState.currentTrip = null;
        if (appState.map) {
            appState.map.remove();
            appState.map = null;
        }
        clearInterval(appState.waitingInterval);
        clearInterval(appState.tripInterval);
        
        document.getElementById('bus-line-select').value = '';
        document.getElementById('bus-line-manual').value = '';

        if (isConnection) {
            startWaitingFromConnection();
        } else {
            showScreen('main-user-interface');
        }
    }

    async function startWaitingFromConnection() {
        // A simplified version of startWaiting, just showing the UI
        try {
            const location = await getCurrentLocation(); // Get location for the new waiting point
            
             // Create a new trip object for the connection
            const previousTrip = appState.currentTrip;
            appState.currentTrip = {
                id: `trip_${Date.now()}`,
                userId: appState.userId,
                lineId: null, // To be selected
                lineName: null,
                lineCost: null,
                events: [{
                    type: 'start_wait',
                    timestamp: new Date().toISOString(),
                    location: { lat: location.lat, lng: location.lng }
                }],
                status: 'waiting',
                connectionFrom: previousTrip ? previousTrip.id : null
            };

            showScreen('journey-start'); // Go back to line selection for the connection
        } catch (error) {
            alert('Não foi possível obter a localização para a conexão. Tente novamente.');
            showScreen('main-user-interface');
        }
    }

    // --- Rating ---
    function submitRating() {
        const ratings = { bus: {}, stop: {} };
        let allRated = true;

        ratingCriteria.bus.forEach(item => {
            const checked = document.querySelector(`input[name="${item.id}"]:checked`);
            if (checked) ratings.bus[item.id] = parseInt(checked.value);
            else allRated = false;
        });
        
        ratingCriteria.stop.forEach(item => {
            const checked = document.querySelector(`input[name="${item.id}"]:checked`);
            if (checked) ratings.stop[item.id] = parseInt(checked.value);
            else allRated = false;
        });
        
        const errorEl = document.getElementById('rating-error');
        if (!allRated) {
            errorEl.textContent = 'Por favor, avalie todos os critérios.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');
        
        appState.currentTrip.ratings = ratings;
        appState.currentTrip.comments = {
            bus: document.getElementById('bus-rating-comments').value,
            stop: document.getElementById('stop-rating-comments').value
        };

        saveTripToHistory();
        showSummary();
    }

    // --- Summary ---
    function showSummary() {
        const startWait = new Date(appState.currentTrip.events.find(e => e.type === 'start_wait').timestamp);
        const startTrip = new Date(appState.currentTrip.events.find(e => e.type === 'start_trip').timestamp);
        const endTrip = new Date(appState.currentTrip.events.find(e => e.type === 'end_trip').timestamp);

        const waitSeconds = Math.floor((startTrip - startWait) / 1000);
        const tripSeconds = Math.floor((endTrip - startTrip) / 1000);
        const totalSeconds = waitSeconds + tripSeconds;
        
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        document.getElementById('summary-wait-time').textContent = formatTime(waitSeconds);
        document.getElementById('summary-trip-time').textContent = formatTime(tripSeconds);
        document.getElementById('summary-total-time').textContent = formatTime(totalSeconds);
        document.getElementById('summary-distance').textContent = '5.2 km'; // Placeholder
        document.getElementById('summary-cost').textContent = `R$ ${appState.currentTrip.lineCost.toFixed(2)}`;

        showScreen('summary-screen');
        
        let countdown = 30;
        const countdownEl = document.getElementById('summary-countdown');
        appState.summaryTimeout = setInterval(() => {
            countdown--;
            countdownEl.textContent = countdown;
            if (countdown <= 0) {
                clearInterval(appState.summaryTimeout);
                resetJourney();
            }
        }, 1000);
    }

    // --- History ---
    async function saveTripToHistory() {
        try {
            await window.firebase.addDoc(window.firebase.collection(appState.db, "users", appState.userId, "history"), appState.currentTrip);
            console.log("Trip saved to history.");
            loadUserHistory();
        } catch (error) {
            console.error("Error saving trip:", error);
        }
    }
    
    async function loadUserHistory() {
        if (!appState.userId) return;

        const historyList = document.getElementById('history-list');
        const noHistoryMsg = document.getElementById('no-history-message');
        
        const q = window.firebase.query(window.firebase.collection(appState.db, "users", appState.userId, "history"));

        window.firebase.onSnapshot(q, (querySnapshot) => {
             historyList.innerHTML = '';
             if (querySnapshot.empty) {
                 noHistoryMsg.classList.remove('hidden');
             } else {
                 noHistoryMsg.classList.add('hidden');
                 querySnapshot.forEach((doc) => {
                     const trip = doc.data();
                     const tripDate = new Date(trip.events[0].timestamp).toLocaleDateString('pt-BR');
                     const el = document.createElement('div');
                     el.className = 'bg-gray-100 p-3 rounded-md';
                     el.innerHTML = `<p class="font-semibold">${trip.lineName}</p>
                                    <p class="text-sm text-gray-600">Data: ${tripDate}</p>`;
                     historyList.appendChild(el);
                 });
             }
        });
    }

    // --- Supervisor Section ---
    let charts = {};
    function initializeDashboard() {
        const dummyData = generateDummyData();
        createDelayChart(dummyData.delays);
        createCausesChart(dummyData.causes);
        createOccupancyChart(dummyData.occupancy);
        createBusRatingChart(dummyData.busRatings);
        createStopItemsChart(dummyData.stopRatings);
        createCostChart(dummyData.costs);
    }
    
     function generateDummyData() {
        const lines = busLines.slice(0, 10).map(l => l.prefix); // Use first 10 lines for demo
        return {
            delays: lines.map(line => ({ line, delay: (Math.random() * 10 - 2) })), // Delays from -2 to 8 mins
            causes: { 'Congestionamento': 40, 'Tempo de embarque': 25, 'Semáforos': 15, 'Manutenção': 10, 'Outros': 10 },
            occupancy: { '06-08h': 85, '09-11h': 60, '12-14h': 75, '15-17h': 50, '18-20h': 90, '21-23h': 40 },
            busRatings: { 'Limpeza': 4.5, 'Tratamento': 5.1, 'Velocidade': 3.8, 'Lotação': 2.5 },
            stopRatings: { 'Rampa': 3.2, 'Cobertura': 4.1, 'Iluminação': 2.8, 'Piso': 4.5, 'Sinalização': 3.9, 'Segurança': 2.5 },
            costs: lines.map(line => ({line, cost: 2.50 + (Math.random() - 0.5) })) // Small variation
        };
    }

    function createOrUpdateChart(chartId, config) {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (charts[chartId]) {
            charts[chartId].destroy();
        }
        charts[chartId] = new Chart(ctx, config);
    }

    function createDelayChart(data) {
         const getBarColor = (delay) => {
            if (delay < 1) return 'rgba(75, 192, 192, 0.6)';   // Verde (Adiantado)
            if (delay <= 3) return 'rgba(255, 206, 86, 0.6)';  // Amarelo (Pontual)
            return 'rgba(255, 99, 132, 0.6)';      // Vermelho (Atrasado)
        };
        const config = {
            type: 'bar',
            data: {
                labels: data.map(d => d.line),
                datasets: [{
                    label: 'Atraso Médio (min)',
                    data: data.map(d => d.delay.toFixed(2)),
                    backgroundColor: data.map(d => getBarColor(d.delay)),
                    borderColor: data.map(d => getBarColor(d.delay).replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' min';
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' min';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        };
        createOrUpdateChart('delay-chart', config);
    }
    
    function createCausesChart(data) {
        const config = {
            type: 'pie',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                     backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed + '%';
                                }
                                return label;
                            }
                        }
                    },
                     datalabels: {
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => {
                                sum += data;
                            });
                            let percentage = (value*100 / sum).toFixed(2)+"%";
                            return percentage;
                        },
                        color: '#fff',
                    }
                }
            }
        };
        createOrUpdateChart('causes-chart', config);
    }

    function createOccupancyChart(data) {
        const config = {
            type: 'line',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Lotação Média (%)',
                    data: Object.values(data),
                    borderColor: '#2F8C56',
                    backgroundColor: 'rgba(47, 140, 86, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            }
        };
        createOrUpdateChart('occupancy-chart', config);
    }

    function createBusRatingChart(data) {
        const config = {
            type: 'radar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Avaliação Média (1-6)',
                    data: Object.values(data),
                    backgroundColor: 'rgba(242, 163, 15, 0.2)',
                    borderColor: '#F2A30F',
                    pointBackgroundColor: '#F2A30F',
                }]
            },
            options: {
                 scales: {
                    r: {
                        beginAtZero: true,
                        max: 6
                    }
                }
            }
        };
         createOrUpdateChart('bus-rating-chart', config);
    }
    
    function createStopItemsChart(data) {
        const config = {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Avaliação Média (1-6)',
                    data: Object.values(data),
                    backgroundColor: '#36A2EB',
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bars
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 6
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        };
        createOrUpdateChart('stop-items-chart', config);
    }
    
    function createCostChart(data) {
         const config = {
            type: 'bar',
            data: {
                labels: data.map(d => d.line),
                datasets: [{
                    label: 'Custo Médio (R$)',
                    data: data.map(d => d.cost),
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                },
                 plugins: {
                    legend: { display: false }
                }
            }
        };
        createOrUpdateChart('cost-chart', config);
    }

    function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'px',
            format: 'a4'
        });

        doc.setFontSize(20);
        doc.text("Relatório de Desempenho - Mobilis", 40, 30);
        doc.setFontSize(12);
        doc.text(`Período: ${document.getElementById('report-period').options[document.getElementById('report-period).selectedIndex].text}`, 40, 45);
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 40, 60);

        const addChartToPDF = (chartId, title, doc) => {
            const canvas = document.getElementById(chartId);
             // Ensure chart has a white background for PDF
            const canvasImage = canvas.toDataURL('image/png', 1.0);
            const chartWidth = doc.internal.pageSize.getWidth() - 80;
            const chartHeight = (canvas.height * chartWidth) / canvas.width;

            doc.addPage('a4', 'l');
            doc.setFontSize(16);
            doc.text(title, 40, 30);
            doc.addImage(canvasImage, 'PNG', 40, 50, chartWidth, chartHeight);
        };
        
        const addChartPairToPDF = (chartId1, title1, chartId2, title2, doc) => {
            const canvas1 = document.getElementById(chartId1);
            const canvas2 = document.getElementById(chartId2);
            const canvasImage1 = canvas1.toDataURL('image/png', 1.0);
            const canvasImage2 = canvas2.toDataURL('image/png', 1.0);

            const chartWidth = (doc.internal.pageSize.getWidth() / 2) - 60;
            const chartHeight1 = (canvas1.height * chartWidth) / canvas1.width;
            const chartHeight2 = (canvas2.height * chartWidth) / canvas2.width;
            
            doc.addPage('a4', 'l');
            doc.setFontSize(14);
            doc.text(title1, 40, 30);
            doc.addImage(canvasImage1, 'PNG', 40, 40, chartWidth, chartHeight1);

            const xPos2 = doc.internal.pageSize.getWidth() / 2 + 20;
            doc.text(title2, xPos2, 30);
            doc.addImage(canvasImage2, 'PNG', xPos2, 40, chartWidth, chartHeight2);
        };

        // Add charts to PDF
        addChartToPDF('delay-chart', 'Atrasos Médios por Linha (minutos)', doc);
        addChartToPDF('causes-chart', 'Causas Prováveis dos Atrasos', doc);
        addChartPairToPDF('occupancy-chart', 'Lotação Média por Horário', 'bus-rating-chart', 'Avaliação Média dos Ônibus', doc);
        addChartPairToPDF('stop-items-chart', 'Avaliação dos Pontos de Ônibus', 'cost-chart', 'Custo Médio por Viagem', doc);


        // Remove the initial blank page
        doc.deletePage(1);

        doc.save(`relatorio_mobilis_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    function switchToUserView() {
        if (appState.currentUser && appState.currentUser.profile === 'supervisor') {
             // Simulate a student login to show the user view
            appState.currentUser = { name: 'Supervisor (Visão Estudante)', course: 'N/A', profile: 'student' };
            setupUserInterface(appState.currentUser.name);
        }
    }
    
    function changeSupervisorPassword() {
        const currentPass = document.getElementById('currentSupervisorPassword').value;
        const newPass = document.getElementById('newSupervisorPassword').value;
        const confirmPass = document.getElementById('confirmNewSupervisorPassword').value;
        const errorEl = document.getElementById('password-change-error');
        const successEl = document.getElementById('password-change-success');
        
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');

        // This is a mock validation. In a real app, this would be a secure server call.
        if (currentPass !== '@#Log!20252') {
            errorEl.textContent = 'Senha atual incorreta.';
            errorEl.classList.remove('hidden');
            return;
        }
        if (newPass.length < 8) {
            errorEl.textContent = 'A nova senha deve ter pelo menos 8 caracteres.';
            errorEl.classList.remove('hidden');
            return;
        }
        if (newPass !== confirmPass) {
            errorEl.textContent = 'As novas senhas não coincidem.';
            errorEl.classList.remove('hidden');
            return;
        }

        // Mock success
        console.log("Password would be changed to:", newPass);
        successEl.textContent = 'Senha alterada com sucesso!';
        successEl.classList.remove('hidden');

        // Clear fields
        document.getElementById('currentSupervisorPassword').value = '';
        document.getElementById('newSupervisorPassword').value = '';
        document.getElementById('confirmNewSupervisorPassword').value = '';
    }
    
    function setupLogoPreviews() {
        const handleFileSelect = (inputId, previewId) => {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        };
        handleFileSelect('logoLeftFile', 'logoLeftPreview');
        handleFileSelect('logoRightFile', 'logoRightPreview');
    }
    
    function saveLogos() {
        const logoLeftSrc = document.getElementById('logoLeftPreview').src;
        const logoRightSrc = document.getElementById('logoRightPreview').src;

        localStorage.setItem('supervisorLogoLeft', logoLeftSrc);
        localStorage.setItem('supervisorLogoRight', logoRightSrc);

        loadLogos();
        alert('Logos salvos com sucesso!');
        showScreen('supervisor-dashboard');
    }

    function loadLogos() {
        const logoLeftSrc = localStorage.getItem('supervisorLogoLeft');
        const logoRightSrc = localStorage.getItem('supervisorLogoRight');
        const logoLeftEl = document.getElementById('supervisorLogoLeft');
        const logoRightEl = document.getElementById('supervisorLogoRight');

        if (logoLeftSrc) {
            logoLeftEl.src = logoLeftSrc;
            logoLeftEl.classList.remove('hidden');
        }
        if (logoRightSrc) {
            logoRightEl.src = logoRightSrc;
            logoRightEl.classList.remove('hidden');
        }
    }
    
    function confirmClearHistories() {
        if (confirm("ATENÇÃO: Esta ação apagará permanentemente todos os históricos de viagens de todos os usuários. Deseja continuar?")) {
            clearAllHistories();
        }
    }

    async function clearAllHistories() {
        alert("Iniciando limpeza de dados. Isso pode levar um momento.");
        try {
            // 1. Get all user documents
            const usersSnapshot = await window.firebase.getDocs(window.firebase.collection(appState.db, "users"));
            
            // 2. For each user, delete their history subcollection
            const batch = window.firebase.writeBatch(appState.db);
            for (const userDoc of usersSnapshot.docs) {
                const historySnapshot = await window.firebase.getDocs(window.firebase.collection(appState.db, "users", userDoc.id, "history"));
                historySnapshot.forEach(historyDoc => {
                    batch.delete(historyDoc.ref);
                });
            }
            
            // 3. Delete realtime_bus data
            const realtimeSnapshot = await window.firebase.getDocs(window.firebase.collection(appState.db, "realtime_bus"));
            realtimeSnapshot.forEach(doc => {
                 batch.delete(doc.ref);
            });

            await batch.commit();

            alert("Todos os históricos de viagem e dados em tempo real foram limpos com sucesso!");
            initializeDashboard(); // Refresh dashboard with empty data
        } catch (error) {
            console.error("Erro ao limpar históricos:", error);
            alert("Ocorreu um erro ao tentar limpar os dados. Verifique o console para mais detalhes.");
        }
    }

    async function generateAISummary() {
        const summaryBox = document.getElementById('ai-summary-box');
        const summaryContent = document.getElementById('ai-summary-content');
        summaryBox.classList.remove('hidden');
        summaryContent.innerHTML = '<p class="animate-pulse">Analisando dados e gerando insights...</p>';
        
        // --- Gemini API Configuration ---
        const API_KEY = ""; // Leave empty to use proxy
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // 1. Collect data from dashboard
        const dashboardData = generateDummyData(); // Using dummy data for this example
        const dataPrompt = `
            Aqui estão os dados de desempenho do transporte de estudantes:
            - Atrasos médios por linha em minutos (valores negativos são adiantamentos): ${JSON.stringify(dashboardData.delays)}
            - Principais causas de atrasos (em %): ${JSON.stringify(dashboardData.causes)}
            - Lotação média dos ônibus por horário (em %): ${JSON.stringify(dashboardData.occupancy)}
            - Avaliações médias dos pontos de ônibus (escala 1-6): ${JSON.stringify(dashboardData.stopRatings)}
            - Avaliações médias dos ônibus (escala 1-6): ${JSON.stringify(dashboardData.busRatings)}
        `;
        
        // 2. Create the prompt for Gemini
        const systemPrompt = `Você é um analista de logística especialista em transporte público. Sua tarefa é analisar os dados fornecidos e gerar um resumo conciso e acionável em português do Brasil. O resumo deve ser formatado em HTML, usando listas e tags <strong> para destacar pontos importantes. Identifique os 2 principais problemas e sugira 2 ações corretivas claras e diretas.`;

        const payload = {
            contents: [{ parts: [{ text: dataPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        
        // 3. Make the API call
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                summaryContent.innerHTML = text;
            } else {
                summaryContent.textContent = "Não foi possível gerar o resumo. A resposta da IA estava vazia.";
            }

        } catch (error) {
            console.error("Error calling Gemini API:", error);
            summaryContent.textContent = "Ocorreu um erro ao tentar gerar o resumo. Verifique o console para detalhes.";
        }
    }


    // --- App Initialization ---
    window.onload = () => {
        initializeFirebase();
        populateBusLines();
        createRatingControls('bus-rating-criteria', ratingCriteria.bus);
        createRatingControls('stop-rating-criteria', ratingCriteria.stop);
        setupLogoPreviews();
        lucide.createIcons();
    };

</script>

</body>
</html>



