<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobilis - IFBA Juazeiro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (Dashboard Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF & jsPDF-AutoTable (PDF Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,routes,geometry" async defer></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, where, getDocs, writeBatch, initializeFirestore, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            signOut,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch,
            initializeFirestore,
            CACHE_SIZE_UNLIMITED
        };
    </script>
    
    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* IFBA Color Palette */
        :root {
            --ifba-green-dark: #1C5240;
            --ifba-green-light: #2F8C56;
            --ifba-accent-gold: #F2A30F;
            --ifba-red-error: #D32F2F;
        }

        .bg-ifba-green-dark { background-color: var(--ifba-green-dark); }
        .text-ifba-green-dark { color: var(--ifba-green-dark); }
        .text-ifba-red-error { color: var(--ifba-red-error); }
        .bg-ifba-green-light { background-color: var(--ifba-green-light); }
        .text-ifba-green-light { color: var(--ifba-green-light); }
        .bg-ifba-accent-gold { background-color: var(--ifba-accent-gold); }
        .text-ifba-accent-gold { color: var(--ifba-accent-gold); }
        .border-ifba-green-dark { border-color: var(--ifba-green-dark); }
        .border-ifba-green-light { border-color: var(--ifba-green-light); }
        
        /* 3D Button Style */
        .btn-3d {
            transition: all 0.15s ease-out;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 0 var(--shadow-color);
        }
        .btn-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 0 var(--shadow-color);
        }
        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 var(--shadow-color);
        }
        .btn-green {
             --shadow-color: #1a493a; /* Darker green */
             background-color: var(--ifba-green-dark);
        }
        .btn-gold {
            --shadow-color: #c8870c; /* Darker gold */
            background-color: var(--ifba-accent-gold);
        }
        .btn-red {
            --shadow-color: #ab2424; /* Darker red */
            background-color: var(--ifba-red-error);
        }
        .btn-purple {
            --shadow-color: #380f6b; /* Darker purple */
            background-color: #4a148c;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--ifba-green-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--ifba-green-dark);
        }
        .hidden {
            display: none;
        }

        /* Centered Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000]">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-ifba-green-dark"></div>
        <p class="mt-4 text-lg text-ifba-green-dark font-semibold">A conectar aos serviços...</p>
    </div>

    <div id="app" class="max-w-4xl mx-auto p-4">

        <!-- Header Logos -->
        <header class="flex justify-between items-center mb-6">
            <img id="supervisorLogoLeft" src="https://placehold.co/150x50/FFFFFF/1C5240?text=Logo+Esquerda" alt="Logo Esquerda" class="h-12 hidden">
            <img id="supervisorLogoRight" src="https://placehold.co/150x50/FFFFFF/1C5240?text=Logo+Direita" alt="Logo Direita" class="h-12 hidden">
        </header>

        <!-- Dynamic Content Area -->
        <main id="content-area">
            <!-- Initial Screen -->
            <div id="initial-screen">
                <div class="text-center mb-8">
                    <img src="mob.png" alt="Mobilis Logo" class="mx-auto w-48 mb-4">
                    <h1 class="text-4xl font-bold text-ifba-green-dark">Mobilis</h1>
                    <p class="text-lg text-gray-600">Monitoramento de Transporte do IFBA Juazeiro</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="showScreen('user-login-screen')" class="p-8 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
                        <i data-lucide="user-round" class="w-16 h-16 mx-auto mb-4 text-ifba-green-dark"></i>
                        <h2 class="text-2xl font-semibold">Sou Estudante</h2>
                        <p class="text-gray-500">Registar e avaliar as minhas viagens.</p>
                    </button>
                    <button onclick="showScreen('supervisor-login-screen')" class="p-8 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
                        <i data-lucide="user-cog" class="w-16 h-16 mx-auto mb-4 text-ifba-green-dark"></i>
                        <h2 class="text-2xl font-semibold">Sou Supervisor</h2>
                        <p class="text-gray-500">Aceder ao painel e relatórios.</p>
                    </button>
                </div>
            </div>

            <!-- User Login/Register Screen -->
            <div id="user-login-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Acesso do Estudante</h2>
                <div id="user-auth-form">
                    <input type="text" id="userName" placeholder="Nome Completo" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <select id="userCourse" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none bg-white">
                        <option value="" disabled selected>Selecione o seu Curso</option>
                        <option>Ensino Médio</option>
                        <option>Curso técnico em Administração</option>
                        <option>Curso técnico em Segurança do Trabalho</option>
                        <option>Curso Superior de Tecnologia em Logística</option>
                    </select>
                    <p id="user-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="loginUser()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Entrar / Registar</button>
                </div>
            </div>

            <!-- Supervisor Login Screen -->
            <div id="supervisor-login-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Acesso do Supervisor</h2>
                <div id="supervisor-auth-form">
                    <input type="text" id="supervisorLogin" placeholder="Login" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <input type="password" id="supervisorPassword" placeholder="Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <p id="supervisor-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="loginSupervisor()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Entrar</button>
                </div>
            </div>
            
            <!-- Main User Interface (after login) -->
            <div id="main-user-interface" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Olá, <span id="display-user-name"></span>!</h2>
                    <button onclick="logout()" class="text-sm text-red-600 hover:underline">Sair</button>
                </div>
                <!-- Journey Steps -->
                <div id="journey-start">
                    <h3 class="text-lg font-semibold mb-2">Iniciar Nova Viagem</h3>
                    <p class="mb-4 text-gray-600">Selecione a linha de ônibus para começar.</p>
                    <select id="bus-line-select" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none bg-white">
                        <option value="" disabled selected>Selecione uma linha...</option>
                    </select>
                    <input type="text" id="bus-line-manual" placeholder="Ou digite o nome/código da linha" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-ifba-green-light outline-none">
                    <p id="bus-line-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button onclick="startWaiting()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-green flex items-center justify-center gap-2">
                        <i data-lucide="timer"></i>
                        Estou à espera do autocarro
                    </button>
                </div>

                <div id="journey-waiting" class="hidden text-center">
                    <h3 class="text-lg font-semibold mb-2">A aguardar o ônibus...</h3>
                    <p class="text-gray-600">Linha: <span id="waiting-bus-line" class="font-bold"></span></p>
                    <div class="my-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-ifba-green-dark mx-auto"></div>
                        <p class="text-4xl font-bold mt-4" id="waiting-timer">00:00</p>
                    </div>
                     <div id="eta-info" class="bg-blue-100 border border-blue-300 text-blue-800 p-3 rounded-md my-4 hidden">
                        <p id="eta-message"></p>
                     </div>
                    <button onclick="startTrip()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-gold flex items-center justify-center gap-2">
                        <i data-lucide="bus-front"></i>
                        Embarquei! Iniciar Viagem
                    </button>
                </div>

                <div id="journey-in-progress" class="hidden">
                     <h3 class="text-lg font-semibold mb-2 text-center">Viagem em andamento...</h3>
                     <p class="text-gray-600 text-center mb-4">Linha: <span id="trip-bus-line" class="font-bold"></span></p>
                    
                     <div id="map-container" class="w-full h-64 bg-gray-200 rounded-lg mb-4 border-2 border-ifba-green-dark">
                         <div id="map" class="h-full w-full"></div>
                     </div>
                     <p class="text-center font-semibold text-lg mb-4">Tempo de viagem: <span id="trip-timer">00:00</span></p>

                    <button onclick="endTrip()" class="w-full p-4 rounded-md text-white font-bold text-lg btn-3d btn-green flex items-center justify-center gap-2">
                        <i data-lucide="flag-off"></i>
                        Desembarque realizado
                    </button>
                </div>

                <!-- User Trip History -->
                <div id="user-history" class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 border-b-2 pb-2 border-ifba-green-light">Histórico de Viagens (Últimas 30)</h3>
                    <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p id="no-history-message" class="text-gray-500">Nenhuma viagem registada ainda.</p>
                    </div>
                </div>
            </div>

            <!-- Connection Popup -->
            <div id="connection-popup" class="popup-overlay hidden">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
                    <h3 class="text-xl font-bold text-ifba-green-dark mb-4">Haverá ligação?</h3>
                    <p class="text-gray-600 mb-6">Vai embarcar em outro ônibus para completar a sua viagem?</p>
                    <div class="flex justify-around">
                        <button onclick="handleConnection(true)" class="px-8 py-3 rounded-md text-white font-semibold btn-3d btn-green">Sim</button>
                        <button onclick="handleConnection(false)" class="px-8 py-3 rounded-md text-white font-semibold btn-3d btn-gold">Não</button>
                    </div>
                </div>
            </div>
            
             <!-- Generic Alert Popup -->
            <div id="alert-popup" class="popup-overlay hidden">
                <div class="bg-white p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
                    <h3 id="alert-title" class="text-xl font-bold text-ifba-red-error mb-4">Atenção</h3>
                    <p id="alert-message" class="text-gray-600 mb-6">Mensagem de erro.</p>
                    <button onclick="closeAlert()" class="px-8 py-3 rounded-md text-white font-semibold btn-3d btn-green">OK</button>
                </div>
            </div>

            <!-- Rating Screen -->
            <div id="rating-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Avalie a sua Viagem</h2>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">Ponto de Ônibus</h3>
                    <div class="space-y-4">
                        <div id="stop-rating-criteria"></div>
                        <textarea id="stop-rating-comments" placeholder="Comentários adicionais sobre a paragem (opcional)" class="w-full p-2 border rounded-md" rows="2"></textarea>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">Ônibus</h3>
                    <div class="space-y-4">
                         <div id="bus-rating-criteria"></div>
                         <textarea id="bus-rating-comments" placeholder="Comentários adicionais sobre o ônibus (opcional)" class="w-full p-2 border rounded-md" rows="2"></textarea>
                    </div>
                </div>
                <p id="rating-error" class="text-red-500 text-sm mt-4 hidden"></p>
                <button onclick="submitRating()" class="w-full mt-6 p-3 rounded-md text-white font-semibold btn-3d btn-green">Enviar Avaliação</button>
            </div>

             <!-- Summary Screen -->
            <div id="summary-screen" class="hidden bg-white p-8 rounded-lg shadow-lg text-center">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Resumo da Viagem</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Tempo de Espera</p>
                        <p id="summary-wait-time" class="text-2xl font-bold">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Tempo de Viagem</p>
                        <p id="summary-trip-time" class="text-2xl font-bold">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg col-span-2 md:col-span-1">
                        <p class="text-sm text-gray-500">Tempo Total</p>
                        <p id="summary-total-time" class="text-2xl font-bold text-ifba-green-dark">--:--</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Distância</p>
                        <p id="summary-distance" class="text-2xl font-bold">-- km</p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-500">Custo Aprox.</p>
                        <p id="summary-cost" class="text-2xl font-bold">R$ --,--</p>
                    </div>
                </div>
                <p class="mt-6 text-gray-500 text-sm">Este ecrã fechará em <span id="summary-countdown">30</span>s.</p>
            </div>

            <!-- Supervisor Dashboard -->
            <div id="supervisor-dashboard" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-ifba-green-dark">Painel do Supervisor</h2>
                     <div>
                        <button onclick="showScreen('supervisor-password-change')" class="text-sm text-blue-600 hover:underline mr-4">Trocar Senha</button>
                        <button onclick="logout()" class="text-sm text-red-600 hover:underline">Sair</button>
                     </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-2">Ações</h3>
                    <div class="flex flex-wrap gap-2">
                        <select id="report-period" class="p-2 border rounded-md bg-white">
                            <option value="daily">Diário</option>
                            <option value="weekly">Semanal</option>
                            <option value="biweekly">Quinzenal</option>
                            <option value="monthly">Mensal</option>
                            <option value="semiannual">Semestral</option>
                            <option value="annual">Anual</option>
                            <option value="custom">Customizado</option>
                        </select>
                        <div id="custom-date-filter" class="hidden space-x-2">
                            <input type="date" id="start-date" class="input-field w-auto">
                            <input type="date" id="end-date" class="input-field w-auto">
                        </div>
                    </div>
                        <button onclick="generatePDFReport()" class="p-2 rounded-md text-white btn-3d btn-green flex items-center gap-1"><i data-lucide="file-down"></i>Gerar PDF</button>
                        <button onclick="showScreen('manage-lines-screen')" class="p-2 rounded-md text-white btn-3d btn-gold flex items-center gap-1"><i data-lucide="bus"></i>Gerir Linhas</button>
                        <button onclick="showScreen('manage-logos-screen')" class="p-2 rounded-md text-white btn-3d btn-gold flex items-center gap-1"><i data-lucide="image"></i>Gerir Logos</button>
                         <button id="clear-history-btn" onclick="confirmClearHistories()" class="p-2 rounded-md text-white flex items-center gap-1 btn-3d btn-red"><i data-lucide="trash-2"></i>Limpar Históricos</button>
                         <button onclick="generateAISummary()" class="p-2 rounded-md text-white flex items-center gap-1 btn-3d btn-purple">✨ Gerar Resumo com IA</button>
                    </div>
                </div>

                <!-- AI Summary Box -->
                <div id="ai-summary-box" class="hidden bg-purple-50 border-l-4 border-purple-500 text-purple-800 p-4 rounded-md mb-6 shadow">
                    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="sparkles"></i>Resumo da Inteligência Artificial</h3>
                    <div id="ai-summary-content" class="text-sm space-y-2">
                        <p class="animate-pulse">A analisar dados e a gerar insights...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Atrasos Médios por Linha (minutos)</h3>
                        <canvas id="delay-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Causas Prováveis dos Atrasos</h3>
                        <canvas id="causes-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Lotação Média por Horário</h3>
                        <canvas id="occupancy-chart"></canvas>
                    </div>
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                         <h3 class="font-semibold mb-2">Avaliação Média dos Itens dos Pontos de Ônibus</h3>
                         <canvas id="stop-items-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Avaliação Média dos Ônibus</h3>
                        <canvas id="bus-rating-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">Custo Médio Total por Viagem</h3>
                        <canvas id="cost-chart"></canvas>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="switchToUserView()" class="p-3 rounded-md text-white font-semibold btn-3d btn-gold">
                        <i data-lucide="user-round" class="inline-block mr-2"></i>Visualizar como Estudante
                    </button>
                </div>

            </div>

             <!-- Supervisor: Manage Lines Screen -->
            <div id="manage-lines-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Gerir Linhas de Ônibus</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Adicionar Nova Linha</h3>
                    <input type="text" id="newLinePrefix" placeholder="Prefixo (Ex: 102)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="text" id="newLineRoute" placeholder="Rota (Ex: João Paulo II - Brisa da Serra)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="text" id="newLineTimes" placeholder="Horários (separados por vírgula)" class="w-full p-2 mb-2 border rounded-md">
                    <input type="number" id="newLineCost" placeholder="Custo Aprox. (Ex: 2.50)" class="w-full p-2 mb-2 border rounded-md">
                    <button onclick="addNewLine()" class="w-full p-2 rounded-md text-white btn-3d btn-green">Adicionar Linha</button>
                </div>
                 <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Importar Linhas (CSV/TXT)</h3>
                    <input type="file" id="importFile" accept=".csv,.txt" class="w-full p-2 border rounded-md">
                    <button onclick="importLines()" class="w-full mt-2 p-2 rounded-md text-white btn-3d btn-gold">Importar Ficheiro</button>
                 </div>

                <h3 class="text-lg font-semibold mb-2">Linhas Registadas</h3>
                <div id="lines-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                
                <button onclick="showScreen('supervisor-dashboard')" class="mt-6 p-3 rounded-md text-ifba-green-dark font-semibold border-2 border-ifba-green-dark hover:bg-gray-100 w-full">Voltar ao Painel</button>
            </div>

            <!-- Supervisor: Change Password Screen -->
            <div id="supervisor-password-change" class="hidden bg-white p-8 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold text-ifba-green-dark mb-6 text-center">Alterar Senha</h2>
                 <input type="password" id="currentSupervisorPassword" placeholder="Senha Atual" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <input type="password" id="newSupervisorPassword" placeholder="Nova Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <input type="password" id="confirmNewSupervisorPassword" placeholder="Confirmar Nova Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                 <p id="password-change-error" class="text-red-500 text-sm mb-4 hidden"></p>
                 <p id="password-change-success" class="text-green-600 text-sm mb-4 hidden"></p>
                 <button onclick="changeSupervisorPassword()" class="w-full p-3 rounded-md text-white font-semibold btn-3d btn-green">Guardar Nova Senha</button>
                 <button onclick="showScreen('supervisor-dashboard')" class="mt-4 w-full text-center text-gray-600 hover:underline">Voltar</button>
            </div>

            <!-- Supervisor: Manage Logos Screen -->
            <div id="manage-logos-screen" class="hidden bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-ifba-green-dark mb-6">Gerir Logos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Logo Esquerdo</h3>
                        <input type="file" id="logoLeftFile" accept="image/*" class="w-full p-2 border rounded-md mb-2">
                        <img id="logoLeftPreview" src="https://placehold.co/200x70?text=Preview" alt="Preview Logo Esquerdo" class="w-full border p-2 rounded-md">
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold mb-2">Logo Direito</h3>
                        <input type="file" id="logoRightFile" accept="image/*" class="w-full p-2 border rounded-md mb-2">
                        <img id="logoRightPreview" src="https://placehold.co/200x70?text=Preview" alt="Preview Logo Direito" class="w-full border p-2 rounded-md">
                    </div>
                </div>
                <button onclick="saveLogos()" class="w-full mt-6 p-3 rounded-md text-white font-semibold btn-3d btn-green">Guardar Logos</button>
                <button onclick="showScreen('supervisor-dashboard')" class="mt-4 w-full text-center text-gray-600 hover:underline">Voltar</button>
            </div>
            
        </main>
    </div>

    <script>
    // --- Application State and Configuration ---
    let appState = {
        isOnline: false,
        currentScreen: 'initial-screen',
        currentUser: null,
        currentTrip: null,
        tripInterval: null,
        waitingInterval: null,
        summaryTimeout: null,
        map: null,
        userMarker: null,
        busMarker: null,
        routePolyline: null,
        db: null,
        auth: null,
        userId: null,
        isAuthReady: false,
    };
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const IFBA_CAMPUS_COORDS = { lat: -9.450303676457963, lng: -40.52378313230595 };
    
    // --- Firebase/Offline Initialization ---
    function initializeApp() {
        const hasFirebaseConfig = typeof __firebase_config !== 'undefined';
        appState.isOnline = hasFirebaseConfig;
        
        if (appState.isOnline) {
            initializeFirebase();
        } else {
            console.warn("Firebase config not found. Running in offline mode.");
            document.getElementById('loading-overlay').classList.add('hidden');
            setupOfflineAuth();
        }
    }

    function initializeFirebase() {
        const effectiveConfig = JSON.parse(__firebase_config);
        
        try {
            const app = window.firebase.initializeApp(effectiveConfig);
            appState.db = window.firebase.initializeFirestore(app, {
                cacheSizeBytes: window.firebase.CACHE_SIZE_UNLIMITED,
            });
            appState.auth = window.firebase.getAuth(app);
            console.log("Firebase initialized in online mode.");
            setupAuthListener();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loading-overlay').classList.add('hidden');
            showAlert("Erro crítico: Não foi possível conectar aos serviços da aplicação.", "Erro de Conexão");
        }
    }

    function setupOfflineAuth() {
        appState.isAuthReady = true;
        appState.userId = 'offline_user_' + Date.now();
        console.log("Running in offline mode with temporary user ID:", appState.userId);
    }

    async function setupAuthListener() {
        const loadingOverlay = document.getElementById('loading-overlay');
        window.firebase.onAuthStateChanged(appState.auth, async (user) => {
            try {
                if (user) {
                    appState.userId = user.uid;
                    appState.isAuthReady = true;
                    console.log("Authentication ready. User UID:", appState.userId);
                    
                    const userDocRef = window.firebase.doc(appState.db, "artifacts", appId, "users", appState.userId);
                    const userDoc = await window.firebase.getDoc(userDocRef);

                    if (userDoc.exists()) {
                        appState.currentUser = userDoc.data();
                        if (appState.currentUser.profile === 'student') {
                            setupUserInterface(appState.currentUser.name);
                        }
                    }
                } else {
                    appState.currentUser = null;
                    appState.userId = null;
                    appState.isAuthReady = false;
                    console.log("User is signed out.");
                    showScreen('initial-screen');
                }
            } catch (error) {
                console.error("Error during auth state change:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        try {
             if (typeof __initial_auth_token !== 'undefined' && !appState.auth.currentUser) {
                await window.firebase.signInWithCustomToken(appState.auth, __initial_auth_token);
             } else if (!appState.auth.currentUser) {
                await window.firebase.signInAnonymously(appState.auth);
             }
        } catch (error) {
            console.error("Automatic sign-in failed:", error);
            showAlert("Não foi possível iniciar uma sessão segura. Tente recarregar a página.", "Erro de Sessão");
            loadingOverlay.classList.add('hidden');
        }
    }

    // --- UI Navigation ---
    function showScreen(screenId) {
        document.querySelectorAll('#content-area > div').forEach(screen => {
            screen.classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
        appState.currentScreen = screenId;
    }

    function showJourneyStep(stepId) {
        document.getElementById('journey-start').classList.add('hidden');
        document.getElementById('journey-waiting').classList.add('hidden');
        document.getElementById('journey-in-progress').classList.add('hidden');
        
        const stepElement = document.getElementById(stepId);
        if (stepElement) {
            stepElement.classList.remove('hidden');
        }
    }

    // --- Popups ---
    function showAlert(message, title = 'Atenção') {
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-message').textContent = message;
        document.getElementById('alert-popup').classList.remove('hidden');
    }

    function closeAlert() {
        document.getElementById('alert-popup').classList.add('hidden');
    }

    // --- Initial Data ---
    let busLines = [
        { id: 1, prefix: '102', route: 'João Paulo II - Residencial Brisa da Serra', cost: 2.50 },
        { id: 2, prefix: '106', route: 'Piranga', cost: 2.50 },
        { id: 3, prefix: '200', route: 'Dom José Rodrigues', cost: 2.50 },
        { id: 4, prefix: '202', route: 'Residencial Doutor Humberto Martins', cost: 2.50 },
        { id: 5, prefix: '203', route: 'Kidé', cost: 2.50 },
        { id: 6, prefix: '204', route: 'Circular Itaberaba', cost: 2.50 },
        { id: 7, prefix: '205', route: 'Tancredo Neves - Castelo Branco', cost: 2.50 },
        { id: 8, prefix: '206', route: 'Residencial Praia do Rodeadouro', cost: 2.50 },
        { id: 9, prefix: '207', route: 'Residencial São Francisco', cost: 2.50 },
        { id: 10, prefix: '208', route: 'Jardim Primavera', cost: 2.50 },
        { id: 11, prefix: '209', route: 'Carnaíba do Sertão', cost: 2.50 },
        { id: 12, prefix: '210', route: 'Rodeadouro', cost: 2.50 },
        { id: 13, prefix: '211', route: 'Curral Novo - Sabiá', cost: 2.50 },
        { id: 14, prefix: '401', route: 'Juazeiro - Petrolina via Centro', cost: 2.50 },
        { id: 15, prefix: '402', route: 'Juazeiro - Petrolina / Areia Branca', cost: 2.50 },
        { id: 16, prefix: '405', route: 'Juazeiro - Sobradinho', cost: 2.50 },
        { id: 17, prefix: '414', route: 'Juazeiro - Petrolina - IF Sertão', cost: 2.50 },
        { id: 18, prefix: '416', route: 'Juazeiro - Petrolina - Expresso', cost: 2.50 },
        { id: 19, prefix: '420', route: 'Juá Garden - Petrolina - Areia Branca', cost: 2.50 },
    ];
    
    const ratingCriteria = {
        bus: [
            { id: 'cleanliness', label: 'Limpeza do veículo' },
            { id: 'driver_treatment', label: 'Tratamento do motorista/cobrador' },
            { id: 'traffic_speed', label: 'Velocidade de tráfego' },
            { id: 'crowding', label: 'Lotação do autocarro' }
        ],
        stop: [
            { id: 'access_ramp', label: 'Rampa de acesso' },
            { id: 'coverage', label: 'Cobertura da paragem' },
            { id: 'lighting', label: 'Iluminação da paragem' },
            { id: 'accessible_floor', label: 'Piso com acessibilidade' },
            { id: 'signaling', label: 'Sinalização' },
            { id: 'security', label: 'Segurança' }
        ]
    };

    const ratingOptions = [
        { value: 1, label: 'Péssimo', emoji: '😠' },
        { value: 2, label: 'Insatisfeito', emoji: '😞' },
        { value: 3, label: 'Razoável', emoji: '😐' },
        { value: 4, label: 'Neutro', emoji: '🙂' },
        { value: 5, label: 'Satisfeito', emoji: '😊' },
        { value: 6, label: 'Plenamente Satisfeito', emoji: '😍' }
    ];

    function populateBusLines() {
        const select = document.getElementById('bus-line-select');
        select.innerHTML = '<option value="" disabled selected>Selecione uma linha...</option>';
        busLines.forEach(line => {
            const option = document.createElement('option');
            option.value = line.id;
            option.textContent = `${line.prefix} - ${line.route}`;
            select.appendChild(option);
        });
    }
    
    function createRatingControls(containerId, criteria) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        criteria.forEach(item => {
            const fieldset = document.createElement('fieldset');
            fieldset.className = 'border p-3 rounded-md';
            fieldset.innerHTML = `<legend class="px-2 font-medium text-gray-700">${item.label}</legend>
                <div class="flex justify-around flex-wrap gap-2" data-criteria="${item.id}">
                    ${ratingOptions.map(opt => `
                        <label class="flex flex-col items-center cursor-pointer text-center">
                            <input type="radio" name="${item.id}" value="${opt.value}" class="hidden peer">
                            <span class="text-3xl p-1 rounded-full peer-checked:bg-yellow-200 transition-colors">${opt.emoji}</span>
                            <span class="text-xs mt-1 text-gray-600">${opt.label}</span>
                        </label>
                    `).join('')}
                </div>`;
            container.appendChild(fieldset);
        });
    }

    // --- Authentication ---
    async function loginUser() {
        const name = document.getElementById('userName').value.trim();
        const course = document.getElementById('userCourse').value;
        const errorEl = document.getElementById('user-error');
        
        if (!name || !course) {
            errorEl.textContent = 'Por favor, preencha todos os campos.';
            errorEl.classList.remove('hidden');
            return;
        }

        if (!appState.isAuthReady || !appState.userId) {
            errorEl.textContent = 'A aguardar autenticação... Tente novamente em um instante.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        appState.currentUser = { name, course, profile: 'student' };
        
        if (appState.isOnline) {
            try {
                const userDocRef = window.firebase.doc(appState.db, "artifacts", appId, "users", appState.userId);
                await window.firebase.setDoc(userDocRef, appState.currentUser);
                console.log("User profile saved for UID:", appState.userId);
            } catch (error) {
                console.error("Error saving user profile online: ", error);
                errorEl.textContent = 'Erro ao guardar o perfil online. Verifique a sua conexão e tente novamente.';
                errorEl.classList.remove('hidden');
                return;
            }
        } else {
             localStorage.setItem('offline_user_profile', JSON.stringify(appState.currentUser));
             console.log("User profile saved for offline mode.");
        }
        
        setupUserInterface(name);
    }

    function setupUserInterface(name) {
        document.getElementById('display-user-name').textContent = name;
        showScreen('main-user-interface');
        showJourneyStep('journey-start');
        loadUserHistory();
    }
    
    function loginSupervisor() {
        const login = document.getElementById('supervisorLogin').value;
        const password = document.getElementById('supervisorPassword').value;
        const errorEl = document.getElementById('supervisor-error');
        
        if (login === 'Logistica2025.1' && password === '@#Log!20252') {
            errorEl.classList.add('hidden');
            appState.currentUser = { name: 'Supervisor', profile: 'supervisor' };
            showScreen('supervisor-dashboard');
            initializeDashboard();
            loadLogos();
        } else {
            errorEl.textContent = 'Login ou senha inválidos.';
            errorEl.classList.remove('hidden');
        }
    }

    function logout() {
        appState.currentUser = null;
        clearInterval(appState.tripInterval);
        clearInterval(appState.waitingInterval);
        clearTimeout(appState.summaryTimeout);
        showScreen('initial-screen');
        document.getElementById('supervisorLogoLeft').classList.add('hidden');
        document.getElementById('supervisorLogoRight').classList.add('hidden');
    }

    // --- User Journey ---
    function getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('A geolocalização não é suportada pelo seu navegador.'));
            } else {
                navigator.geolocation.getCurrentPosition(
                    position => resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    }),
                    () => reject(new Error('Não foi possível obter a sua localização. Por favor, autorize o acesso à sua localização no seu navegador.'))
                );
            }
        });
    }

    async function startWaiting() {
        const selectedLineId = document.getElementById('bus-line-select').value;
        const manualLine = document.getElementById('bus-line-manual').value.trim();
        const errorEl = document.getElementById('bus-line-error');

        let line;
        if (selectedLineId) {
            line = busLines.find(l => l.id == selectedLineId);
        } else if (manualLine) {
            line = { id: `manual_${Date.now()}`, prefix: manualLine, route: 'Rota manual', cost: 2.50 };
        }

        if (!line) {
            errorEl.textContent = 'Por favor, selecione ou digite uma linha.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        try {
            const location = await getCurrentLocation();
            
            appState.currentTrip = {
                id: `trip_${Date.now()}`,
                userId: appState.userId,
                lineId: line.id,
                lineName: `${line.prefix} - ${line.route}`,
                lineCost: line.cost,
                events: [],
                status: 'waiting',
            };
            
            appState.currentTrip.events.push({
                type: 'start_wait',
                timestamp: new Date().toISOString(),
                location: { lat: location.lat, lng: location.lng }
            });

            document.getElementById('waiting-bus-line').textContent = appState.currentTrip.lineName;
            showJourneyStep('journey-waiting');

            let seconds = 0;
            const timerEl = document.getElementById('waiting-timer');
            appState.waitingInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.textContent = `${mins}:${secs}`;
            }, 1000);

            await checkETA(line.id);

        } catch (error) {
            showAlert(error.message, 'Erro de Localização');
        }
    }

    async function checkETA(lineId) {
        const etaInfo = document.getElementById('eta-info');
        const etaMessage = document.getElementById('eta-message');
        etaInfo.classList.add('hidden');
        
        if (!appState.isAuthReady || !appState.isOnline) { return; }

        try {
            const realtimeCollRef = window.firebase.collection(appState.db, "artifacts", appId, "public", "data", "realtime_bus");
            const q = window.firebase.query(realtimeCollRef, window.firebase.where("lineId", "==", lineId));
            const querySnapshot = await window.firebase.getDocs(q);

            if (!querySnapshot.empty) {
                const busDoc = querySnapshot.docs[0].data();
                const userLocation = await getCurrentLocation();
                
                const directionsService = new google.maps.DirectionsService();
                const request = {
                    origin: new google.maps.LatLng(busDoc.location.lat, busDoc.location.lng),
                    destination: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    travelMode: 'DRIVING'
                };

                directionsService.route(request, (result, status) => {
                    if (status == 'OK' && result.routes.length > 0) {
                        const eta = result.routes[0].legs[0].duration.text;
                        const lastSeenTime = new Date(busDoc.timestamp);
                        const now = new Date();
                        const diffMinutes = Math.round((now - lastSeenTime) / (1000 * 60));
                        etaMessage.textContent = `Previsão de chegada: ${eta}. (Baseado num autocarro que passou por um ponto próximo há ${diffMinutes} min).`;
                        etaInfo.classList.remove('hidden');
                    }
                });
            } else {
                 etaMessage.textContent = 'A aguardar informações de outros utilizadores para estimar a chegada.';
                 etaInfo.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error checking ETA:", error);
        }
    }


    async function startTrip() {
        clearInterval(appState.waitingInterval);
        
        if (!appState.isAuthReady || !appState.userId) {
            showAlert("A conexão com os serviços ainda não está pronta. Tente novamente em um instante.", "Erro de Conexão");
            return;
        }

        try {
            const location = await getCurrentLocation();
            appState.currentTrip.events.push({
                type: 'start_trip',
                timestamp: new Date().toISOString(),
                location: { lat: location.lat, lng: location.lng }
            });
            appState.currentTrip.status = 'in_progress';
            
            if (appState.isOnline) {
                const busDocRef = window.firebase.doc(appState.db, "artifacts", appId, "public", "data", "realtime_bus", appState.currentTrip.lineId.toString());
                await window.firebase.setDoc(busDocRef, {
                    lineId: appState.currentTrip.lineId,
                    location: { lat: location.lat, lng: location.lng },
                    timestamp: new Date().toISOString()
                });
            } else {
                console.log("Offline mode: Skipping real-time bus update.");
            }

            document.getElementById('trip-bus-line').textContent = appState.currentTrip.lineName;
            showJourneyStep('journey-in-progress');

            initializeMap(location);

            let seconds = 0;
            const timerEl = document.getElementById('trip-timer');
            appState.tripInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.textContent = `${mins}:${secs}`;
            }, 1000);

        } catch(error) {
            showAlert('Erro ao iniciar a viagem: ' + error.message, 'Erro');
            showJourneyStep('journey-start');
        }
    }
    
    function initializeMap(startLocation) {
        if (appState.map) {
             try { appState.map.remove(); } catch(e) { console.warn("Could not remove map cleanly."); }
        }
        
        if (!window.google || !window.google.maps || !window.google.maps.geometry) {
            document.getElementById('map').innerHTML = '<p class="text-center p-4 text-red-600">Erro ao carregar o mapa. Verifique a chave da API do Google Maps.</p>';
            return;
        }

        const mapElement = document.getElementById('map');
        appState.map = L.map(mapElement).setView([startLocation.lat, startLocation.lng], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(appState.map);

        const busIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448653.png', iconSize: [38, 38] });
        appState.busMarker = L.marker([startLocation.lat, startLocation.lng], { icon: busIcon }).addTo(appState.map).bindPopup("Autocarro");

        const ifbaIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/9906/9906517.png', iconSize: [38, 38] });
        L.marker([IFBA_CAMPUS_COORDS.lat, IFBA_CAMPUS_COORDS.lng], { icon: ifbaIcon }).addTo(appState.map).bindPopup("IFBA Campus Juazeiro");

        const directionsService = new google.maps.DirectionsService();
        const request = {
            origin: new google.maps.LatLng(startLocation.lat, startLocation.lng),
            destination: new google.maps.LatLng(IFBA_CAMPUS_COORDS.lat, IFBA_CAMPUS_COORDS.lng),
            travelMode: 'DRIVING'
        };

        directionsService.route(request, (result, status) => {
            if (status == 'OK' && result.routes.length > 0) {
                const route = result.routes[0];
                const latlngs = google.maps.geometry.encoding.decodePath(route.overview_polyline).map(p => [p.lat(), p.lng()]);
                
                if (appState.routePolyline) {
                    appState.map.removeLayer(appState.routePolyline);
                }
                appState.routePolyline = L.polyline(latlngs, { color: 'blue' }).addTo(appState.map);
                appState.map.fitBounds(appState.routePolyline.getBounds());
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
    }


    function endTrip() {
        clearInterval(appState.tripInterval);
        appState.currentTrip.events.push({
            type: 'end_trip',
            timestamp: new Date().toISOString(),
            location: null
        });
        appState.currentTrip.status = 'ended';
        document.getElementById('connection-popup').classList.remove('hidden');
    }

    function handleConnection(willConnect) {
        document.getElementById('connection-popup').classList.add('hidden');
        if (willConnect) {
            saveTripToHistory();
            resetJourney(true);
        } else {
            showScreen('rating-screen');
        }
    }
    
    function resetJourney(isConnection = false) {
        if (!isConnection) appState.currentTrip = null;

        if (appState.map) {
            try { appState.map.remove(); } catch(e) {}
            appState.map = null;
        }
        clearInterval(appState.waitingInterval);
        clearInterval(appState.tripInterval);
        
        document.getElementById('bus-line-select').value = '';
        document.getElementById('bus-line-manual').value = '';

        if (isConnection) {
            startWaitingFromConnection();
        } else {
            showScreen('main-user-interface');
            showJourneyStep('journey-start');
        }
    }

    async function startWaitingFromConnection() {
        try {
            const location = await getCurrentLocation();
            
            appState.currentTrip = {
                id: `trip_${Date.now()}`,
                userId: appState.userId,
                lineId: null,
                lineName: null,
                lineCost: null,
                events: [{
                    type: 'start_wait',
                    timestamp: new Date().toISOString(),
                    location: { lat: location.lat, lng: location.lng }
                }],
                status: 'waiting',
                connectionFrom: appState.currentTrip ? appState.currentTrip.id : null
            };
            showScreen('main-user-interface');
            showJourneyStep('journey-start');
        } catch (error) {
            showAlert('Não foi possível obter a localização para a ligação. Tente novamente.', 'Erro');
            showScreen('main-user-interface');
            showJourneyStep('journey-start');
        }
    }

    // --- Rating ---
    function submitRating() {
        const ratings = { bus: {}, stop: {} };
        let allRated = true;

        ratingCriteria.bus.forEach(item => {
            const checked = document.querySelector(`input[name="${item.id}"]:checked`);
            if (checked) ratings.bus[item.id] = parseInt(checked.value);
            else allRated = false;
        });
        
        ratingCriteria.stop.forEach(item => {
            const checked = document.querySelector(`input[name="${item.id}"]:checked`);
            if (checked) ratings.stop[item.id] = parseInt(checked.value);
            else allRated = false;
        });
        
        const errorEl = document.getElementById('rating-error');
        if (!allRated) {
            errorEl.textContent = 'Por favor, avalie todos os critérios.';
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');
        
        appState.currentTrip.ratings = ratings;
        appState.currentTrip.comments = {
            bus: document.getElementById('bus-rating-comments').value,
            stop: document.getElementById('stop-rating-comments').value
        };

        saveTripToHistory();
        showSummary();
    }

    // --- Summary ---
    function showSummary() {
        const startWait = new Date(appState.currentTrip.events.find(e => e.type === 'start_wait').timestamp);
        const startTrip = new Date(appState.currentTrip.events.find(e => e.type === 'start_trip').timestamp);
        const endTrip = new Date(appState.currentTrip.events.find(e => e.type === 'end_trip').timestamp);

        const waitSeconds = Math.floor((startTrip - startWait) / 1000);
        const tripSeconds = Math.floor((endTrip - startTrip) / 1000);
        
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        document.getElementById('summary-wait-time').textContent = formatTime(waitSeconds);
        document.getElementById('summary-trip-time').textContent = formatTime(tripSeconds);
        document.getElementById('summary-total-time').textContent = formatTime(waitSeconds + tripSeconds);
        document.getElementById('summary-distance').textContent = '5.2 km'; // Placeholder
        document.getElementById('summary-cost').textContent = `R$ ${appState.currentTrip.lineCost.toFixed(2)}`;

        showScreen('summary-screen');
        
        let countdown = 30;
        const countdownEl = document.getElementById('summary-countdown');
        appState.summaryTimeout = setInterval(() => {
            countdown--;
            countdownEl.textContent = countdown;
            if (countdown <= 0) {
                clearInterval(appState.summaryTimeout);
                resetJourney();
            }
        }, 1000);
    }

    // --- History ---
    async function saveTripToHistory() {
        if (!appState.isAuthReady || !appState.userId) {
            console.error("Auth not ready. Cannot save trip to history.");
            showAlert("Erro de autenticação: Não foi possível guardar a viagem.", "Erro");
            return;
        }
        
        if (appState.isOnline) {
            try {
                const historyCollRef = window.firebase.collection(appState.db, "artifacts", appId, "users", appState.userId, "history");
                await window.firebase.addDoc(historyCollRef, appState.currentTrip);
                console.log("Trip saved to history for UID:", appState.userId);
            } catch (error) {
                console.error("Error saving trip online:", error);
                showAlert("Erro ao guardar a viagem online. Verifique a sua conexão.", "Erro");
            }
        } else {
            let history = JSON.parse(localStorage.getItem('offline_history') || '[]');
            history.push(appState.currentTrip);
            localStorage.setItem('offline_history', JSON.stringify(history));
            console.log("Trip saved to offline history.");
        }
        loadUserHistory();
    }
    
    async function loadUserHistory() {
        if (!appState.isAuthReady || !appState.userId) { return; }

        const historyList = document.getElementById('history-list');
        const noHistoryMsg = document.getElementById('no-history-message');
        
        const renderHistory = (trips) => {
            historyList.innerHTML = '';
            if (!trips || trips.length === 0) {
                 noHistoryMsg.classList.remove('hidden');
            } else {
                 noHistoryMsg.classList.add('hidden');
                 trips.forEach(trip => {
                     const tripDate = new Date(trip.events[0].timestamp).toLocaleDateString('pt-BR');
                     const el = document.createElement('div');
                     el.className = 'bg-gray-100 p-3 rounded-md';
                     el.innerHTML = `<p class="font-semibold">${trip.lineName}</p>
                                    <p class="text-sm text-gray-600">Data: ${tripDate}</p>`;
                     historyList.appendChild(el);
                 });
            }
        };
        
        if(appState.isOnline) {
            const historyCollRef = window.firebase.collection(appState.db, "artifacts", appId, "users", appState.userId, "history");
            const q = window.firebase.query(historyCollRef);
            window.firebase.onSnapshot(q, (querySnapshot) => {
                 const trips = querySnapshot.docs.map(doc => doc.data());
                 renderHistory(trips);
            }, (error) => {
                console.error("Error loading history online:", error);
            });
        } else {
            const trips = JSON.parse(localStorage.getItem('offline_history') || '[]');
            renderHistory(trips);
        }
    }

    // --- Supervisor Section ---
    let charts = {};
    function initializeDashboard() {
        const dummyData = generateDummyData();
        createDelayChart(dummyData.delays);
        createCausesChart(dummyData.causes);
        createOccupancyChart(dummyData.occupancy);
        createBusRatingChart(dummyData.busRatings);
        createStopItemsChart(dummyData.stopRatings);
        createCostChart(dummyData.costs);
    }
    
     function generateDummyData() {
        const lines = busLines.slice(0, 10).map(l => l.prefix);
        return {
            delays: lines.map(line => ({ line, delay: (Math.random() * 10 - 2) })),
            causes: { 'Congestionamento': 40, 'Tempo de embarque': 25, 'Semáforos': 15, 'Manutenção': 10, 'Outros': 10 },
            occupancy: { '06-08h': 85, '09-11h': 60, '12-14h': 75, '15-17h': 50, '18-20h': 90, '21-23h': 40 },
            busRatings: { 'Limpeza': 4.5, 'Tratamento': 5.1, 'Velocidade': 3.8, 'Lotação': 2.5 },
            stopRatings: { 'Rampa': 3.2, 'Cobertura': 4.1, 'Iluminação': 2.8, 'Piso': 4.5, 'Sinalização': 3.9, 'Segurança': 2.5 },
            costs: lines.map(line => ({line, cost: 2.50 + (Math.random() - 0.5) }))
        };
    }

    function createOrUpdateChart(chartId, config) {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (charts[chartId]) {
            charts[chartId].destroy();
        }
        charts[chartId] = new Chart(ctx, config);
    }

    function createDelayChart(data) {
         const getBarColor = (delay) => {
            if (delay < 1) return 'rgba(75, 192, 192, 0.6)';
            if (delay <= 3) return 'rgba(255, 206, 86, 0.6)';
            return 'rgba(255, 99, 132, 0.6)';
        };
        const config = {
            type: 'bar',
            data: {
                labels: data.map(d => d.line),
                datasets: [{
                    label: 'Atraso Médio (min)',
                    data: data.map(d => d.delay.toFixed(2)),
                    backgroundColor: data.map(d => getBarColor(d.delay)),
                    borderColor: data.map(d => getBarColor(d.delay).replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' min';
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' min';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        };
        createOrUpdateChart('delay-chart', config);
    }
    
    function createCausesChart(data) {
        const config = {
            type: 'pie',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                     backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) { label += context.parsed + '%'; }
                                return label;
                            }
                        }
                    }
                }
            }
        };
        createOrUpdateChart('causes-chart', config);
    }

    function createOccupancyChart(data) {
        const config = {
            type: 'line',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Lotação Média (%)',
                    data: Object.values(data),
                    borderColor: '#2F8C56',
                    backgroundColor: 'rgba(47, 140, 86, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            }
        };
        createOrUpdateChart('occupancy-chart', config);
    }

    function createBusRatingChart(data) {
        const config = {
            type: 'radar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Avaliação Média (1-6)',
                    data: Object.values(data),
                    backgroundColor: 'rgba(242, 163, 15, 0.2)',
                    borderColor: '#F2A30F',
                    pointBackgroundColor: '#F2A30F',
                }]
            },
            options: {
                 scales: { r: { beginAtZero: true, max: 6 } }
            }
        };
         createOrUpdateChart('bus-rating-chart', config);
    }
    
    function createStopItemsChart(data) {
        const config = {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Avaliação Média (1-6)',
                    data: Object.values(data),
                    backgroundColor: '#36A2EB',
                }]
            },
            options: {
                indexAxis: 'y',
                scales: { x: { beginAtZero: true, max: 6 } },
                plugins: { legend: { display: false } }
            }
        };
        createOrUpdateChart('stop-items-chart', config);
    }
    
    function createCostChart(data) {
         const config = {
            type: 'bar',
            data: {
                labels: data.map(d => d.line),
                datasets: [{
                    label: 'Custo Médio (R$)',
                    data: data.map(d => d.cost),
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) { return 'R$ ' + value.toFixed(2); }
                        }
                    }
                },
                 plugins: { legend: { display: false } }
            }
        };
        createOrUpdateChart('cost-chart', config);
    }

    function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });

        doc.setFontSize(20);
        doc.text("Relatório de Desempenho - Mobilis", 40, 30);
        doc.setFontSize(12);
        const reportPeriodEl = document.getElementById('report-period');
        doc.text(`Período: ${reportPeriodEl.options[reportPeriodEl.selectedIndex].text}`, 40, 45);
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 40, 60);

        const addChartToPDF = (chartId, title, doc) => {
            const canvas = document.getElementById(chartId);
            const canvasImage = canvas.toDataURL('image/png', 1.0);
            const chartWidth = doc.internal.pageSize.getWidth() - 80;
            const chartHeight = (canvas.height * chartWidth) / canvas.width;
            doc.addPage('a4', 'l');
            doc.setFontSize(16);
            doc.text(title, 40, 30);
            doc.addImage(canvasImage, 'PNG', 40, 50, chartWidth, chartHeight);
        };
        
        const addChartPairToPDF = (chartId1, title1, chartId2, title2, doc) => {
            const canvas1 = document.getElementById(chartId1);
            const canvas2 = document.getElementById(chartId2);
            const canvasImage1 = canvas1.toDataURL('image/png', 1.0);
            const canvasImage2 = canvas2.toDataURL('image/png', 1.0);
            const chartWidth = (doc.internal.pageSize.getWidth() / 2) - 60;
            const chartHeight1 = (canvas1.height * chartWidth) / canvas1.width;
            const chartHeight2 = (canvas2.height * chartWidth) / canvas2.width;
            doc.addPage('a4', 'l');
            doc.setFontSize(14);
            doc.text(title1, 40, 30);
            doc.addImage(canvasImage1, 'PNG', 40, 40, chartWidth, chartHeight1);
            const xPos2 = doc.internal.pageSize.getWidth() / 2 + 20;
            doc.text(title2, xPos2, 30);
            doc.addImage(canvasImage2, 'PNG', xPos2, 40, chartWidth, chartHeight2);
        };

        addChartToPDF('delay-chart', 'Atrasos Médios por Linha (minutos)', doc);
        addChartToPDF('causes-chart', 'Causas Prováveis dos Atrasos', doc);
        addChartPairToPDF('occupancy-chart', 'Lotação Média por Horário', 'bus-rating-chart', 'Avaliação Média dos Autocarros', doc);
        addChartPairToPDF('stop-items-chart', 'Avaliação das Paragens de Autocarro', 'cost-chart', 'Custo Médio por Viagem', doc);

        doc.deletePage(1);
        doc.save(`relatorio_mobilis_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    function switchToUserView() {
        if (appState.currentUser && appState.currentUser.profile === 'supervisor') {
            appState.currentUser = { name: 'Supervisor (Visão Estudante)', course: 'N/A', profile: 'student' };
            setupUserInterface(appState.currentUser.name);
        }
    }
    
    function changeSupervisorPassword() {
        const currentPass = document.getElementById('currentSupervisorPassword').value;
        const newPass = document.getElementById('newSupervisorPassword').value;
        const confirmPass = document.getElementById('confirmNewSupervisorPassword').value;
        const errorEl = document.getElementById('password-change-error');
        const successEl = document.getElementById('password-change-success');
        
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');

        if (currentPass !== '@#Log!20252') {
            errorEl.textContent = 'Senha atual incorreta.';
            errorEl.classList.remove('hidden');
            return;
        }
        if (newPass.length < 8) {
            errorEl.textContent = 'A nova senha deve ter pelo menos 8 caracteres.';
            errorEl.classList.remove('hidden');
            return;
        }
        if (newPass !== confirmPass) {
            errorEl.textContent = 'As novas senhas não coincidem.';
            errorEl.classList.remove('hidden');
            return;
        }

        console.log("Password would be changed to:", newPass);
        successEl.textContent = 'Senha alterada com sucesso!';
        successEl.classList.remove('hidden');

        document.getElementById('currentSupervisorPassword').value = '';
        document.getElementById('newSupervisorPassword').value = '';
        document.getElementById('confirmNewSupervisorPassword').value = '';
    }
    
    function setupLogoPreviews() {
        const handleFileSelect = (inputId, previewId) => {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { preview.src = e.target.result; };
                    reader.readAsDataURL(file);
                }
            });
        };
        handleFileSelect('logoLeftFile', 'logoLeftPreview');
        handleFileSelect('logoRightFile', 'logoRightPreview');
    }
    
    function saveLogos() {
        const logoLeftSrc = document.getElementById('logoLeftPreview').src;
        const logoRightSrc = document.getElementById('logoRightPreview').src;
        localStorage.setItem('supervisorLogoLeft', logoLeftSrc);
        localStorage.setItem('supervisorLogoRight', logoRightSrc);
        loadLogos();
        showAlert('Logos guardados com sucesso!', 'Sucesso');
        showScreen('supervisor-dashboard');
    }

    function loadLogos() {
        const logoLeftSrc = localStorage.getItem('supervisorLogoLeft');
        const logoRightSrc = localStorage.getItem('supervisorLogoRight');
        const logoLeftEl = document.getElementById('supervisorLogoLeft');
        const logoRightEl = document.getElementById('supervisorLogoRight');

        if (logoLeftSrc) {
            logoLeftEl.src = logoLeftSrc;
            logoLeftEl.classList.remove('hidden');
        }
        if (logoRightSrc) {
            logoRightEl.src = logoRightSrc;
            logoRightEl.classList.remove('hidden');
        }
    }
    
    function confirmClearHistories() {
        if (confirm("ATENÇÃO: Esta ação apagará permanentemente todos os históricos de viagens de todos os utilizadores. Deseja continuar?")) {
            clearAllHistories();
        }
    }

    async function clearAllHistories() {
        if (appState.isOnline) {
            showAlert("A iniciar a limpeza de dados online. Isto pode levar um momento.", "Aguarde");
            if (!appState.isAuthReady) {
                showAlert("Erro: A autenticação é necessária para realizar esta operação.", "Erro");
                return;
            }
            try {
                const usersCollRef = window.firebase.collection(appState.db, "artifacts", appId, "users");
                const usersSnapshot = await window.firebase.getDocs(usersCollRef);
                
                const batch = window.firebase.writeBatch(appState.db);
                for (const userDoc of usersSnapshot.docs) {
                    const historyCollRef = window.firebase.collection(appState.db, "artifacts", appId, "users", userDoc.id, "history");
                    const historySnapshot = await window.firebase.getDocs(historyCollRef);
                    historySnapshot.forEach(historyDoc => { batch.delete(historyDoc.ref); });
                }
                
                const realtimeCollRef = window.firebase.collection(appState.db, "artifacts", appId, "public", "data", "realtime_bus");
                const realtimeSnapshot = await window.firebase.getDocs(realtimeCollRef);
                realtimeSnapshot.forEach(doc => { batch.delete(doc.ref); });

                await batch.commit();

                showAlert("Todos os históricos de viagem e dados em tempo real foram limpos com sucesso!", "Sucesso");
                initializeDashboard();
            } catch (error) {
                console.error("Erro ao limpar históricos:", error);
                showAlert("Ocorreu um erro ao tentar limpar os dados. Verifique a consola para mais detalhes.", "Erro");
            }
        } else {
            // Offline logic
            showAlert("A limpar dados locais.", "Aguarde");
            localStorage.removeItem('offline_history');
            localStorage.removeItem('offline_user_profile');
            showAlert("Históricos locais limpos com sucesso!", "Sucesso");
            initializeDashboard(); // Refresh dashboard with empty data
        }
    }

    async function generateAISummary() {
        const summaryBox = document.getElementById('ai-summary-box');
        const summaryContent = document.getElementById('ai-summary-content');
        summaryBox.classList.remove('hidden');
        summaryContent.innerHTML = '<p class="animate-pulse">A analisar dados e a gerar insights...</p>';
        
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        const dashboardData = generateDummyData();
        const dataPrompt = `
            Aqui estão os dados de desempenho do transporte de estudantes:
            - Atrasos médios por linha em minutos (valores negativos são adiantamentos): ${JSON.stringify(dashboardData.delays)}
            - Principais causas de atrasos (em %): ${JSON.stringify(dashboardData.causes)}
            - Lotação média dos autocarros por horário (em %): ${JSON.stringify(dashboardData.occupancy)}
            - Avaliações médias das paragens de autocarro (escala 1-6): ${JSON.stringify(dashboardData.stopRatings)}
            - Avaliações médias dos autocarros (escala 1-6): ${JSON.stringify(dashboardData.busRatings)}
        `;
        
        const systemPrompt = `Você é um analista de logística especialista em transporte público. A sua tarefa é analisar os dados fornecidos e gerar um resumo conciso e acionável em português do Brasil. O resumo deve ser formatado em HTML, usando listas e tags <strong> para destacar pontos importantes. Identifique os 2 principais problemas e sugira 2 ações corretivas claras e diretas.`;

        const payload = {
            contents: [{ parts: [{ text: dataPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                summaryContent.innerHTML = text;
            } else {
                summaryContent.textContent = "Não foi possível gerar o resumo. A resposta da IA estava vazia.";
            }

        } catch (error) {
            console.error("Error calling Gemini API:", error);
            summaryContent.textContent = "Ocorreu um erro ao tentar gerar o resumo. Verifique a consola para detalhes.";
        }
    }

    // --- App Initialization ---
    window.onload = () => {
        initializeApp();
        populateBusLines();
        createRatingControls('bus-rating-criteria', ratingCriteria.bus);
        createRatingControls('stop-rating-criteria', ratingCriteria.stop);
        setupLogoPreviews();
        lucide.createIcons();
    };

</script>

</body>
</html>


